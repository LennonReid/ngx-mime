import * as d3 from 'd3';
import * as OpenSeadragon from 'openseadragon';
import { Dimensions } from '../models/dimensions';
import { ViewerLayout } from '../models/viewer-layout';
import { ViewerMode } from '../models/viewer-mode';
import { ViewerOptions } from '../models/viewer-options';
import { Utils } from '../utils';
import { ZoomUtils } from './zoom-utils';
export class ZoomStrategy {
    constructor(viewer, canvasService, modeService, viewerLayoutService) {
        this.viewer = viewer;
        this.canvasService = canvasService;
        this.modeService = modeService;
        this.viewerLayoutService = viewerLayoutService;
    }
    setMinZoom(mode) {
        this.viewer.viewport.minZoomLevel = this.getHomeZoomLevel(mode);
    }
    getMinZoom() {
        return Utils.shortenDecimals(this.viewer.viewport.getMinZoom(), 5);
    }
    getMaxZoom() {
        return Utils.shortenDecimals(this.viewer.viewport.getMaxZoom(), 5);
    }
    getZoom() {
        return Utils.shortenDecimals(this.viewer.viewport.getZoom(true), 5);
    }
    goToHomeZoom() {
        this.zoomTo(this.getHomeZoomLevel(this.modeService.mode));
        if (this.modeService.isPageZoomed()) {
            this.modeService.mode = ViewerMode.PAGE;
        }
    }
    zoomTo(level, position) {
        if (level !== 0) {
            this.viewer.viewport.zoomTo(level, position);
        }
    }
    getHomeZoomLevel(mode) {
        if (!this.viewer || !this.canvasService || !this.viewer.container) {
            return 1;
        }
        let currentCanvasHeight;
        let currentCanvasWidth;
        let viewportBounds;
        const currentCanvasGroupRect = this.canvasService.getCurrentCanvasGroupRect();
        currentCanvasHeight = currentCanvasGroupRect.height;
        currentCanvasWidth = currentCanvasGroupRect.width;
        viewportBounds =
            mode === ViewerMode.DASHBOARD
                ? this.getDashboardViewportBounds()
                : this.viewer.viewport.getBounds();
        return this.getFittedZoomLevel(viewportBounds, currentCanvasHeight, currentCanvasWidth);
    }
    zoomIn(zoomFactor, position) {
        if (!zoomFactor) {
            zoomFactor = ViewerOptions.zoom.zoomFactor;
        }
        if (position) {
            position = this.viewer.viewport.pointFromPixel(position);
            if (position) {
                position = ZoomUtils.constrainPositionToCanvasGroup(position, this.canvasService.getCurrentCanvasGroupRect());
            }
        }
        if (this.modeService.mode !== ViewerMode.PAGE_ZOOMED) {
            this.modeService.mode = ViewerMode.PAGE_ZOOMED;
        }
        this.zoomBy(zoomFactor, position);
    }
    zoomOut(zoomFactor, position) {
        if (!zoomFactor) {
            zoomFactor = Math.pow(ViewerOptions.zoom.zoomFactor, -1);
        }
        if (position) {
            position = this.viewer.viewport.pointFromPixel(position);
            if (position) {
                position = ZoomUtils.constrainPositionToCanvasGroup(position, this.canvasService.getCurrentCanvasGroupRect());
            }
        }
        if (this.isViewportLargerThanCanvasGroup()) {
            this.modeService.mode = ViewerMode.PAGE;
        }
        else {
            this.zoomBy(zoomFactor, position);
        }
    }
    getDashboardViewportBounds() {
        const homeZoomFactor = this.getHomeZoomFactor();
        const maxViewportDimensions = new Dimensions(d3
            .select(this.viewer.container.parentNode.parentNode)
            .node()
            .getBoundingClientRect());
        const viewportHeight = maxViewportDimensions.height -
            ViewerOptions.padding.header -
            ViewerOptions.padding.footer;
        const viewportWidth = maxViewportDimensions.width * homeZoomFactor;
        const viewportSizeInViewportCoordinates = this.viewer.viewport.deltaPointsFromPixels(new OpenSeadragon.Point(viewportWidth, viewportHeight));
        return new OpenSeadragon.Rect(0, 0, viewportSizeInViewportCoordinates.x, viewportSizeInViewportCoordinates.y);
    }
    getFittedZoomLevel(viewportBounds, canvasGroupHeight, canvasGroupWidth) {
        const currentZoom = this.viewer.viewport.getZoom();
        const resizeRatio = viewportBounds.height / canvasGroupHeight;
        if (resizeRatio * canvasGroupWidth <= viewportBounds.width) {
            return Utils.shortenDecimals(resizeRatio * currentZoom, 5);
        }
        else {
            // Canvas group at full height is wider than viewport.  Return fit by width instead.
            return Utils.shortenDecimals((viewportBounds.width / canvasGroupWidth) * currentZoom, 5);
        }
    }
    zoomBy(zoomFactor, position) {
        const currentZoom = this.viewer.viewport.getZoom(false);
        zoomFactor = ZoomUtils.constraintZoomFactor(zoomFactor, currentZoom, this.getMaxZoom());
        this.viewer.viewport.zoomBy(zoomFactor, position);
    }
    isViewportLargerThanCanvasGroup() {
        const canvasGroupRec = this.canvasService.getCurrentCanvasGroupRect();
        const viewportBounds = this.viewer.viewport.getBounds();
        const pbWidth = Math.round(canvasGroupRec.width);
        const pbHeight = Math.round(canvasGroupRec.height);
        const vpWidth = Math.round(viewportBounds.width);
        const vpHeight = Math.round(viewportBounds.height);
        return vpHeight >= pbHeight || vpWidth >= pbWidth;
    }
    getHomeZoomFactor() {
        return this.modeService.mode === ViewerMode.DASHBOARD
            ? this.getDashboardZoomHomeFactor()
            : 1;
    }
    getDashboardZoomHomeFactor() {
        return this.viewerLayoutService.layout === ViewerLayout.ONE_PAGE
            ? 0.85
            : 0.66;
    }
}
export class DefaultZoomStrategy extends ZoomStrategy {
    constructor(viewer, canvasService, modeService, viewerLayoutService) {
        super(viewer, canvasService, modeService, viewerLayoutService);
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiem9vbS1zdHJhdGVneS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uLy4uLy4uL2xpYnMvbmd4LW1pbWUvc3JjL2xpYi9jb3JlL3ZpZXdlci1zZXJ2aWNlL3pvb20tc3RyYXRlZ3kudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxLQUFLLEVBQUUsTUFBTSxJQUFJLENBQUM7QUFDekIsT0FBTyxLQUFLLGFBQWEsTUFBTSxlQUFlLENBQUM7QUFHL0MsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLHNCQUFzQixDQUFDO0FBR2xELE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSx5QkFBeUIsQ0FBQztBQUN2RCxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sdUJBQXVCLENBQUM7QUFDbkQsT0FBTyxFQUFFLGFBQWEsRUFBRSxNQUFNLDBCQUEwQixDQUFDO0FBQ3pELE9BQU8sRUFBRSxLQUFLLEVBQUUsTUFBTSxVQUFVLENBQUM7QUFFakMsT0FBTyxFQUFFLFNBQVMsRUFBRSxNQUFNLGNBQWMsQ0FBQztBQW9CekMsTUFBTSxPQUFPLFlBQVk7SUFDdkIsWUFDWSxNQUFXLEVBQ1gsYUFBNEIsRUFDNUIsV0FBd0IsRUFDeEIsbUJBQXdDO1FBSHhDLFdBQU0sR0FBTixNQUFNLENBQUs7UUFDWCxrQkFBYSxHQUFiLGFBQWEsQ0FBZTtRQUM1QixnQkFBVyxHQUFYLFdBQVcsQ0FBYTtRQUN4Qix3QkFBbUIsR0FBbkIsbUJBQW1CLENBQXFCO0lBQ2pELENBQUM7SUFFSixVQUFVLENBQUMsSUFBZ0I7UUFDekIsSUFBSSxDQUFDLE1BQU0sQ0FBQyxRQUFRLENBQUMsWUFBWSxHQUFHLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUNsRSxDQUFDO0lBRUQsVUFBVTtRQUNSLE9BQU8sS0FBSyxDQUFDLGVBQWUsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLFFBQVEsQ0FBQyxVQUFVLEVBQUUsRUFBRSxDQUFD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dCAqIGFzIE9wZW5TZWFkcmFnb24gZnJvbSAnb3BlbnNlYWRyYWdvbic7XG5pbXBvcnQgeyBDYW52YXNTZXJ2aWNlIH0gZnJvbSAnLi4vY2FudmFzLXNlcnZpY2UvY2FudmFzLXNlcnZpY2UnO1xuaW1wb3J0IHsgTW9kZVNlcnZpY2UgfSBmcm9tICcuLi9tb2RlLXNlcnZpY2UvbW9kZS5zZXJ2aWNlJztcbmltcG9ydCB7IERpbWVuc2lvbnMgfSBmcm9tICcuLi9tb2RlbHMvZGltZW5zaW9ucyc7XG5pbXBvcnQgeyBEaXJlY3Rpb24gfSBmcm9tICcuLi9tb2RlbHMvZGlyZWN0aW9uJztcbmltcG9ydCB7IFBvaW50IH0gZnJvbSAnLi4vbW9kZWxzL3BvaW50JztcbmltcG9ydCB7IFZpZXdlckxheW91dCB9IGZyb20gJy4uL21vZGVscy92aWV3ZXItbGF5b3V0JztcbmltcG9ydCB7IFZpZXdlck1vZGUgfSBmcm9tICcuLi9tb2RlbHMvdmlld2VyLW1vZGUnO1xuaW1wb3J0IHsgVmlld2VyT3B0aW9ucyB9IGZyb20gJy4uL21vZGVscy92aWV3ZXItb3B0aW9ucyc7XG5pbXBvcnQgeyBVdGlscyB9IGZyb20gJy4uL3V0aWxzJztcbmltcG9ydCB7IFZpZXdlckxheW91dFNlcnZpY2UgfSBmcm9tICcuLi92aWV3ZXItbGF5b3V0LXNlcnZpY2Uvdmlld2VyLWxheW91dC1zZXJ2aWNlJztcbmltcG9ydCB7IFpvb21VdGlscyB9IGZyb20gJy4vem9vbS11dGlscyc7XG5cbmV4cG9ydCBpbnRlcmZhY2UgQ2FudmFzR3JvdXAge1xuICBjYW52YXNHcm91cEluZGV4OiBudW1iZXI7XG4gIGNhbnZhc0dyb3VwRW5kSGl0Q291bnRSZWFjaGVkPzogYm9vbGVhbjtcbiAgZGlyZWN0aW9uOiBEaXJlY3Rpb247XG4gIGltbWVkaWF0ZWx5OiBib29sZWFuO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIFN0cmF0ZWd5IHtcbiAgc2V0TWluWm9vbShtb2RlOiBWaWV3ZXJNb2RlKTogdm9pZDtcbiAgZ2V0TWluWm9vbSgpOiBudW1iZXI7XG4gIGdldE1heFpvb20oKTogbnVtYmVyO1xuICBnZXRab29tKCk6IG51bWJlcjtcbiAgZ29Ub0hvbWVab29tKCk6IHZvaWQ7XG4gIHpvb21UbyhsZXZlbDogbnVtYmVyLCBwb3NpdGlvbj86IFBvaW50KTogdm9pZDtcbiAgem9vbUluKHpvb21GYWN0b3I/OiBudW1iZXIsIHBvc2l0aW9uPzogUG9pbnQpOiB2b2lkO1xuICB6b29tT3V0KHpvb21GYWN0b3I/OiBudW1iZXIsIHBvc2l0aW9uPzogUG9pbnQpOiB2b2lkO1xufVxuXG5leHBvcnQgY2xhc3MgWm9vbVN0cmF0ZWd5IHtcbiAgY29uc3RydWN0b3IoXG4gICAgcHJvdGVjdGVkIHZpZXdlcjogYW55LFxuICAgIHByb3RlY3RlZCBjYW52YXNTZXJ2aWNlOiBDYW52YXNTZXJ2aWNlLFxuICAgIHByb3RlY3RlZCBtb2RlU2VydmljZTogTW9kZVNlcnZpY2UsXG4gICAgcHJvdGVjdGVkIHZpZXdlckxheW91dFNlcnZpY2U6IFZpZXdlckxheW91dFNlcnZpY2VcbiAgKSB7fVxuXG4gIHNldE1pblpvb20obW9kZTogVmlld2VyTW9kZSk6IHZvaWQge1xuICAgIHRoaXMudmlld2VyLnZpZXdwb3J0Lm1pblpvb21MZXZlbCA9IHRoaXMuZ2V0SG9tZVpvb21MZXZlbChtb2RlKTtcbiAgfVxuXG4gIGdldE1pblpvb20oKTogbnVtYmVyIHtcbiAgICByZXR1cm4gVXRpbHMuc2hvcnRlbkRlY2ltYWxzKHRoaXMudmlld2VyLnZpZXdwb3J0LmdldE1pblpvb20oKSwgNSk7XG4gIH1cblxuICBnZXRNYXhab29tKCk6IG51bWJlciB7XG4gICAgcmV0dXJuIFV0aWxzLnNob3J0ZW5EZWNpbWFscyh0aGlzLnZpZXdlci52aWV3cG9ydC5nZXRNYXhab29tKCksIDUpO1xuICB9XG5cbiAgZ2V0Wm9vbSgpOiBudW1iZXIge1xuICAgIHJldHVybiBVdGlscy5zaG9ydGVuRGVjaW1hbHModGhpcy52aWV3ZXIudmlld3BvcnQuZ2V0Wm9vbSh0cnVlKSwgNSk7XG4gIH1cblxuICBnb1RvSG9tZVpvb20oKTogdm9pZCB7XG4gICAgdGhpcy56b29tVG8odGhpcy5nZXRIb21lWm9vbUxldmVsKHRoaXMubW9kZVNlcnZpY2UubW9kZSkpO1xuICAgIGlmICh0aGlzLm1vZGVTZXJ2aWNlLmlzUGFnZVpvb21lZCgpKSB7XG4gICAgICB0aGlzLm1vZGVTZXJ2aWNlLm1vZGUgPSBWaWV3ZXJNb2RlLlBBR0U7XG4gICAgfVxuICB9XG5cbiAgem9vbVRvKGxldmVsOiBudW1iZXIsIHBvc2l0aW9uPzogUG9pbnQpOiB2b2lkIHtcbiAgICBpZiAobGV2ZWwgIT09IDApIHtcbiAgICAgIHRoaXMudmlld2VyLnZpZXdwb3J0Lnpvb21UbyhsZXZlbCwgcG9zaXRpb24pO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgZ2V0SG9tZVpvb21MZXZlbChtb2RlOiBWaWV3ZXJNb2RlKTogbnVtYmVyIHtcbiAgICBpZiAoIXRoaXMudmlld2VyIHx8ICF0aGlzLmNhbnZhc1NlcnZpY2UgfHwgIXRoaXMudmlld2VyLmNvbnRhaW5lcikge1xuICAgICAgcmV0dXJuIDE7XG4gICAgfVxuXG4gICAgbGV0IGN1cnJlbnRDYW52YXNIZWlnaHQ6IG51bWJlcjtcbiAgICBsZXQgY3VycmVudENhbnZhc1dpZHRoOiBudW1iZXI7XG4gICAgbGV0IHZpZXdwb3J0Qm91bmRzOiBhbnk7XG5cbiAgICBjb25zdCBjdXJyZW50Q2FudmFzR3JvdXBSZWN0ID1cbiAgICAgIHRoaXMuY2FudmFzU2VydmljZS5nZXRDdXJyZW50Q2FudmFzR3JvdXBSZWN0KCk7XG4gICAgY3VycmVudENhbnZhc0hlaWdodCA9IGN1cnJlbnRDYW52YXNHcm91cFJlY3QuaGVpZ2h0O1xuICAgIGN1cnJlbnRDYW52YXNXaWR0aCA9IGN1cnJlbnRDYW52YXNHcm91cFJlY3Qud2lkdGg7XG4gICAgdmlld3BvcnRCb3VuZHMgPVxuICAgICAgbW9kZSA9PT0gVmlld2VyTW9kZS5EQVNIQk9BUkRcbiAgICAgICAgPyB0aGlzLmdldERhc2hib2FyZFZpZXdwb3J0Qm91bmRzKClcbiAgICAgICAgOiB0aGlzLnZpZXdlci52aWV3cG9ydC5nZXRCb3VuZHMoKTtcblxuICAgIHJldHVybiB0aGlzLmdldEZpdHRlZFpvb21MZXZlbChcbiAgICAgIHZpZXdwb3J0Qm91bmRzLFxuICAgICAgY3VycmVudENhbnZhc0hlaWdodCxcbiAgICAgIGN1cnJlbnRDYW52YXNXaWR0aFxuICAgICk7XG4gIH1cblxuICB6b29tSW4oem9vbUZhY3Rvcj86IG51bWJlciwgcG9zaXRpb24/OiBQb2ludCk6IHZvaWQge1xuICAgIGlmICghem9vbUZhY3Rvcikge1xuICAgICAgem9vbUZhY3RvciA9IFZpZXdlck9wdGlvbnMuem9vbS56b29tRmFjdG9yO1xuICAgIH1cblxuICAgIGlmIChwb3NpdGlvbikge1xuICAgICAgcG9zaXRpb24gPSB0aGlzLnZpZXdlci52aWV3cG9ydC5wb2ludEZyb21QaXhlbChwb3NpdGlvbik7XG4gICAgICBpZiAocG9zaXRpb24pIHtcbiAgICAgICAgcG9zaXRpb24gPSBab29tVXRpbHMuY29uc3RyYWluUG9zaXRpb25Ub0NhbnZhc0dyb3VwKFxuICAgICAgICAgIHBvc2l0aW9uLFxuICAgICAgICAgIHRoaXMuY2FudmFzU2VydmljZS5nZXRDdXJyZW50Q2FudmFzR3JvdXBSZWN0KClcbiAgICAgICAgKTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICBpZiAodGhpcy5tb2RlU2VydmljZS5tb2RlICE9PSBWaWV3ZXJNb2RlLlBBR0VfWk9PTUVEKSB7XG4gICAgICB0aGlzLm1vZGVTZXJ2aWNlLm1vZGUgPSBWaWV3ZXJNb2RlLlBBR0VfWk9PTUVEO1xuICAgIH1cblxuICAgIHRoaXMuem9vbUJ5KHpvb21GYWN0b3IsIHBvc2l0aW9uKTtcbiAgfVxuXG4gIHpvb21PdXQoem9vbUZhY3Rvcj86IG51bWJlciwgcG9zaXRpb24/OiBQb2ludCk6IHZvaWQge1xuICAgIGlmICghem9vbUZhY3Rvcikge1xuICAgICAgem9vbUZhY3RvciA9IE1hdGgucG93KFZpZXdlck9wdGlvbnMuem9vbS56b29tRmFjdG9yLCAtMSk7XG4gICAgfVxuXG4gICAgaWYgKHBvc2l0aW9uKSB7XG4gICAgICBwb3NpdGlvbiA9IHRoaXMudmlld2VyLnZpZXdwb3J0LnBvaW50RnJvbVBpeGVsKHBvc2l0aW9uKTtcbiAgICAgIGlmIChwb3NpdGlvbikge1xuICAgICAgICBwb3NpdGlvbiA9IFpvb21VdGlscy5jb25zdHJhaW5Qb3NpdGlvblRvQ2FudmFzR3JvdXAoXG4gICAgICAgICAgcG9zaXRpb24sXG4gICAgICAgICAgdGhpcy5jYW52YXNTZXJ2aWNlLmdldEN1cnJlbnRDYW52YXNHcm91cFJlY3QoKVxuICAgICAgICApO1xuICAgICAgfVxuICAgIH1cblxuICAgIGlmICh0aGlzLmlzVmlld3BvcnRMYXJnZXJUaGFuQ2FudmFzR3JvdXAoKSkge1xuICAgICAgdGhpcy5tb2RlU2VydmljZS5tb2RlID0gVmlld2VyTW9kZS5QQUdFO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLnpvb21CeSh6b29tRmFjdG9yLCBwb3NpdGlvbik7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBnZXREYXNoYm9hcmRWaWV3cG9ydEJvdW5kcygpOiBhbnkge1xuICAgIGNvbnN0IGhvbWVab29tRmFjdG9yID0gdGhpcy5nZXRIb21lWm9vbUZhY3RvcigpO1xuICAgIGNvbnN0IG1heFZpZXdwb3J0RGltZW5zaW9ucyA9IG5ldyBEaW1lbnNpb25zKFxuICAgICAgZDNcbiAgICAgICAgLnNlbGVjdCh0aGlzLnZpZXdlci5jb250YWluZXIucGFyZW50Tm9kZS5wYXJlbnROb2RlKVxuICAgICAgICAubm9kZSgpXG4gICAgICAgIC5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKVxuICAgICk7XG4gICAgY29uc3Qgdmlld3BvcnRIZWlnaHQgPVxuICAgICAgbWF4Vmlld3BvcnREaW1lbnNpb25zLmhlaWdodCAtXG4gICAgICBWaWV3ZXJPcHRpb25zLnBhZGRpbmcuaGVhZGVyIC1cbiAgICAgIFZpZXdlck9wdGlvbnMucGFkZGluZy5mb290ZXI7XG4gICAgY29uc3Qgdmlld3BvcnRXaWR0aCA9IG1heFZpZXdwb3J0RGltZW5zaW9ucy53aWR0aCAqIGhvbWVab29tRmFjdG9yO1xuXG4gICAgY29uc3Qgdmlld3BvcnRTaXplSW5WaWV3cG9ydENvb3JkaW5hdGVzID1cbiAgICAgIHRoaXMudmlld2VyLnZpZXdwb3J0LmRlbHRhUG9pbnRzRnJvbVBpeGVscyhcbiAgICAgICAgbmV3IE9wZW5TZWFkcmFnb24uUG9pbnQodmlld3BvcnRXaWR0aCwgdmlld3BvcnRIZWlnaHQpXG4gICAgICApO1xuXG4gICAgcmV0dXJuIG5ldyBPcGVuU2VhZHJhZ29uLlJlY3QoXG4gICAgICAwLFxuICAgICAgMCxcbiAgICAgIHZpZXdwb3J0U2l6ZUluVmlld3BvcnRDb29yZGluYXRlcy54LFxuICAgICAgdmlld3BvcnRTaXplSW5WaWV3cG9ydENvb3JkaW5hdGVzLnlcbiAgICApO1xuICB9XG5cbiAgcHJpdmF0ZSBnZXRGaXR0ZWRab29tTGV2ZWwoXG4gICAgdmlld3BvcnRCb3VuZHM6IGFueSxcbiAgICBjYW52YXNHcm91cEhlaWdodDogbnVtYmVyLFxuICAgIGNhbnZhc0dyb3VwV2lkdGg6IG51bWJlclxuICApIHtcbiAgICBjb25zdCBjdXJyZW50Wm9vbTogbnVtYmVyID0gdGhpcy52aWV3ZXIudmlld3BvcnQuZ2V0Wm9vbSgpO1xuICAgIGNvbnN0IHJlc2l6ZVJhdGlvOiBudW1iZXIgPSB2aWV3cG9ydEJvdW5kcy5oZWlnaHQgLyBjYW52YXNHcm91cEhlaWdodDtcblxuICAgIGlmIChyZXNpemVSYXRpbyAqIGNhbnZhc0dyb3VwV2lkdGggPD0gdmlld3BvcnRCb3VuZHMud2lkdGgpIHtcbiAgICAgIHJldHVybiBVdGlscy5zaG9ydGVuRGVjaW1hbHMocmVzaXplUmF0aW8gKiBjdXJyZW50Wm9vbSwgNSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIC8vIENhbnZhcyBncm91cCBhdCBmdWxsIGhlaWdodCBpcyB3aWRlciB0aGFuIHZpZXdwb3J0LiAgUmV0dXJuIGZpdCBieSB3aWR0aCBpbnN0ZWFkLlxuICAgICAgcmV0dXJuIFV0aWxzLnNob3J0ZW5EZWNpbWFscyhcbiAgICAgICAgKHZpZXdwb3J0Qm91bmRzLndpZHRoIC8gY2FudmFzR3JvdXBXaWR0aCkgKiBjdXJyZW50Wm9vbSxcbiAgICAgICAgNVxuICAgICAgKTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIHpvb21CeSh6b29tRmFjdG9yOiBudW1iZXIsIHBvc2l0aW9uPzogUG9pbnQpOiB2b2lkIHtcbiAgICBjb25zdCBjdXJyZW50Wm9vbSA9IHRoaXMudmlld2VyLnZpZXdwb3J0LmdldFpvb20oZmFsc2UpO1xuICAgIHpvb21GYWN0b3IgPSBab29tVXRpbHMuY29uc3RyYWludFpvb21GYWN0b3IoXG4gICAgICB6b29tRmFjdG9yLFxuICAgICAgY3VycmVudFpvb20sXG4gICAgICB0aGlzLmdldE1heFpvb20oKVxuICAgICk7XG4gICAgdGhpcy52aWV3ZXIudmlld3BvcnQuem9vbUJ5KHpvb21GYWN0b3IsIHBvc2l0aW9uKTtcbiAgfVxuXG4gIHByaXZhdGUgaXNWaWV3cG9ydExhcmdlclRoYW5DYW52YXNHcm91cCgpOiBib29sZWFuIHtcbiAgICBjb25zdCBjYW52YXNHcm91cFJlYyA9IHRoaXMuY2FudmFzU2VydmljZS5nZXRDdXJyZW50Q2FudmFzR3JvdXBSZWN0KCk7XG4gICAgY29uc3Qgdmlld3BvcnRCb3VuZHMgPSB0aGlzLnZpZXdlci52aWV3cG9ydC5nZXRCb3VuZHMoKTtcbiAgICBjb25zdCBwYldpZHRoID0gTWF0aC5yb3VuZChjYW52YXNHcm91cFJlYy53aWR0aCk7XG4gICAgY29uc3QgcGJIZWlnaHQgPSBNYXRoLnJvdW5kKGNhbnZhc0dyb3VwUmVjLmhlaWdodCk7XG4gICAgY29uc3QgdnBXaWR0aCA9IE1hdGgucm91bmQodmlld3BvcnRCb3VuZHMud2lkdGgpO1xuICAgIGNvbnN0IHZwSGVpZ2h0ID0gTWF0aC5yb3VuZCh2aWV3cG9ydEJvdW5kcy5oZWlnaHQpO1xuICAgIHJldHVybiB2cEhlaWdodCA+PSBwYkhlaWdodCB8fCB2cFdpZHRoID49IHBiV2lkdGg7XG4gIH1cblxuICBwcml2YXRlIGdldEhvbWVab29tRmFjdG9yKCkge1xuICAgIHJldHVybiB0aGlzLm1vZGVTZXJ2aWNlLm1vZGUgPT09IFZpZXdlck1vZGUuREFTSEJPQVJEXG4gICAgICA/IHRoaXMuZ2V0RGFzaGJvYXJkWm9vbUhvbWVGYWN0b3IoKVxuICAgICAgOiAxO1xuICB9XG5cbiAgcHJpdmF0ZSBnZXREYXNoYm9hcmRab29tSG9tZUZhY3RvcigpIHtcbiAgICByZXR1cm4gdGhpcy52aWV3ZXJMYXlvdXRTZXJ2aWNlLmxheW91dCA9PT0gVmlld2VyTGF5b3V0Lk9ORV9QQUdFXG4gICAgICA/IDAuODVcbiAgICAgIDogMC42NjtcbiAgfVxufVxuXG5leHBvcnQgY2xhc3MgRGVmYXVsdFpvb21TdHJhdGVneSBleHRlbmRzIFpvb21TdHJhdGVneSBpbXBsZW1lbnRzIFN0cmF0ZWd5IHtcbiAgY29uc3RydWN0b3IoXG4gICAgdmlld2VyOiBhbnksXG4gICAgY2FudmFzU2VydmljZTogQ2FudmFzU2VydmljZSxcbiAgICBtb2RlU2VydmljZTogTW9kZVNlcnZpY2UsXG4gICAgdmlld2VyTGF5b3V0U2VydmljZTogVmlld2VyTGF5b3V0U2VydmljZVxuICApIHtcbiAgICBzdXBlcih2aWV3ZXIsIGNhbnZhc1NlcnZpY2UsIG1vZGVTZXJ2aWNlLCB2aWV3ZXJMYXlvdXRTZXJ2aWNlKTtcbiAgfVxufVxuIl19