import { HighlightRect } from '../../models/highlight-rect';
import { Utils } from '../../utils';
import { Hit } from './../../models/hit';
import { SearchResult } from './../../models/search-result';
export class SearchResultBuilder {
    constructor(q, manifest, iiifSearchResult, config) {
        this.q = q;
        this.manifest = manifest;
        this.iiifSearchResult = iiifSearchResult;
        this.config = config;
    }
    build() {
        const searchResult = new SearchResult();
        searchResult.q = this.q;
        if (this.iiifSearchResult && this.iiifSearchResult.hits) {
            this.iiifSearchResult.hits.forEach((hit, index) => {
                const id = index;
                let startCanvasIndex = -1;
                let label;
                const highlightRects = [];
                if (this.manifest.sequences && this.manifest.sequences[0].canvases) {
                    const resources = this.findResources(hit);
                    resources.forEach((resource, index) => {
                        if (index === 0) {
                            startCanvasIndex = this.findSequenceIndex(resource);
                            label = this.findLabel(startCanvasIndex);
                        }
                        const canvasIndex = this.findSequenceIndex(resource);
                        const on = resource.on;
                        if (on) {
                            const scale = this.getScale(canvasIndex);
                            const coords = on.substring(on.indexOf('=') + 1).split(',');
                            const rect = new HighlightRect({
                                x: this.scaleValue(coords[0], scale),
                                y: this.scaleValue(coords[1], scale),
                                width: this.scaleValue(coords[2], scale),
                                height: this.scaleValue(coords[3], scale),
                                canvasIndex
                            });
                            highlightRects.push(rect);
                        }
                    });
                }
                searchResult.add(new Hit({
                    id: id,
                    index: startCanvasIndex,
                    label: label,
                    match: hit.match,
                    before: hit.before,
                    after: hit.after,
                    highlightRects,
                }));
            });
        }
        return searchResult;
    }
    findResources(hit) {
        const resources = [];
        if (hit.annotations) {
            for (const annotation of hit.annotations) {
                if (this.iiifSearchResult.resources) {
                    const res = this.iiifSearchResult.resources.find((r) => r['@id'] === annotation);
                    if (res) {
                        resources.push(res);
                    }
                }
            }
        }
        return resources;
    }
    findSequenceIndex(resource) {
        if (!this.manifest.sequences) {
            throw new Error('No sequences found!');
        }
        const firstSequence = this.getFirstSequence();
        const on = resource.on;
        if (on && firstSequence && firstSequence.canvases) {
            const id = on.substring(0, on.indexOf('#'));
            return firstSequence.canvases.findIndex((c) => c.id === id);
        }
        return -1;
    }
    findLabel(index) {
        if (index === -1) {
            return undefined;
        }
        else {
            const canvas = this.getFirstSequenceCanvas(index);
            return canvas ? canvas.label : undefined;
        }
    }
    getFirstSequence() {
        const sequences = this.manifest.sequences;
        return sequences ? sequences[0] : undefined;
    }
    getFirstSequenceCanvas(index) {
        const firstSequence = this.getFirstSequence();
        return firstSequence && firstSequence.canvases !== undefined
            ? firstSequence.canvases[index]
            : undefined;
    }
    getScale(index) {
        const physicalScale = this.getPhysicalScale(index);
        return Utils.getScaleFactor(physicalScale, this.config?.ignorePhysicalScale);
    }
    getPhysicalScale(index) {
        const canvas = this.getFirstSequenceCanvas(index);
        return canvas?.images?.[0].resource?.service?.service?.physicalScale;
    }
    scaleValue(value, scale) {
        return Math.trunc(parseInt(value, 10) * scale);
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2VhcmNoLXJlc3VsdC5idWlsZGVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vLi4vLi4vLi4vbGlicy9uZ3gtbWltZS9zcmMvbGliL2NvcmUvYnVpbGRlcnMvaWlpZi9zZWFyY2gtcmVzdWx0LmJ1aWxkZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQ0EsT0FBTyxFQUFFLGFBQWEsRUFBRSxNQUFNLDZCQUE2QixDQUFDO0FBQzVELE9BQU8sRUFBRSxLQUFLLEVBQUUsTUFBTSxhQUFhLENBQUM7QUFDcEMsT0FBTyxFQUFFLEdBQUcsRUFBRSxNQUFNLG9CQUFvQixDQUFDO0FBT3pDLE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSw4QkFBOEIsQ0FBQztBQUU1RCxNQUFNLE9BQU8sbUJBQW1CO0lBQzlCLFlBQ1UsQ0FBUyxFQUNULFFBQWtCLEVBQ2xCLGdCQUFrQyxFQUNsQyxNQUF3QjtRQUh4QixNQUFDLEdBQUQsQ0FBQyxDQUFRO1FBQ1QsYUFBUSxHQUFSLFFBQVEsQ0FBVTtRQUNsQixxQkFBZ0IsR0FBaEIsZ0JBQWdCLENBQWtCO1FBQ2xDLFdBQU0sR0FBTixNQUFNLENBQWtCO0lBQy9CLENBQUM7SUFFRyxLQUFLO1FBQ1YsTUFBTSxZQUFZLEdBQUcsSUFBSSxZQUFZLEVBQUUsQ0FBQztRQUN4QyxZQUFZLENBQUMsQ0FBQyxHQUFHLElBQUksQ0FBQyxDQUFDLENBQUM7UUFDeEIsSUFBSSxJQUFJLENBQUMsZ0JBQWdCLElBQUksSUFBSSxDQUFDLGdCQUFnQixDQUFDLElBQUksRUFBRTtZQUN2RCxJQUFJLENBQUMsZ0JBQWdCLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFDLEdBQVksRUFBRSxLQUFhLEVBQUUsRUFBRTtnQkFDakUsTUFBTSxFQUFFLEdBQVcsS0FBSyxDQUFDO2dCQUN6QixJQUFJLGdCQUFnQixHQUFHLENBQUMsQ0FBQyxDQUFDO2dCQUMxQixJQUFJLEtBQUssQ0FBQztnQkFDVixNQUFN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QUFDLEtBQWE7UUFDMUMsTUFBTSxhQUFhLEdBQUcsSUFBSSxDQUFDLGdCQUFnQixFQUFFLENBQUM7UUFDOUMsT0FBTyxhQUFhLElBQUksYUFBYSxDQUFDLFFBQVEsS0FBSyxTQUFTO1lBQzFELENBQUMsQ0FBQyxhQUFhLENBQUMsUUFBUSxDQUFDLEtBQUssQ0FBQztZQUMvQixDQUFDLENBQUMsU0FBUyxDQUFDO0lBQ2hCLENBQUM7SUFFTyxRQUFRLENBQUMsS0FBYTtRQUM1QixNQUFNLGFBQWEsR0FBRyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsS0FBSyxDQUFDLENBQUM7UUFDbkQsT0FBTyxLQUFLLENBQUMsY0FBYyxDQUN6QixhQUFhLEVBQ2IsSUFBSSxDQUFDLE1BQU0sRUFBRSxtQkFBbUIsQ0FDakMsQ0FBQztJQUNKLENBQUM7SUFFTyxnQkFBZ0IsQ0FBQyxLQUFhO1FBQ3BDLE1BQU0sTUFBTSxHQUFHLElBQUksQ0FBQyxzQkFBc0IsQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUNsRCxPQUFPLE1BQU0sRUFBRSxNQUFNLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxRQUFRLEVBQUUsT0FBTyxFQUFFLE9BQU8sRUFBRSxhQUFhLENBQUM7SUFDdkUsQ0FBQztJQUVPLFVBQVUsQ0FBQyxLQUFhLEVBQUUsS0FBYTtRQUM3QyxPQUFPLElBQUksQ0FBQyxLQUFLLENBQUMsUUFBUSxDQUFDLEtBQUssRUFBRSxFQUFFLENBQUMsR0FBRyxLQUFLLENBQUMsQ0FBQztJQUNqRCxDQUFDO0NBQ0YiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBNaW1lVmlld2VyQ29uZmlnIH0gZnJvbSAnLi4vLi4vbWltZS12aWV3ZXItY29uZmlnJztcbmltcG9ydCB7IEhpZ2hsaWdodFJlY3QgfSBmcm9tICcuLi8uLi9tb2RlbHMvaGlnaGxpZ2h0LXJlY3QnO1xuaW1wb3J0IHsgVXRpbHMgfSBmcm9tICcuLi8uLi91dGlscyc7XG5pbXBvcnQgeyBIaXQgfSBmcm9tICcuLy4uLy4uL21vZGVscy9oaXQnO1xuaW1wb3J0IHtcbiAgSGl0IGFzIElpaWZIaXQsXG4gIElpaWZTZWFyY2hSZXN1bHQsXG4gIFJlc291cmNlIGFzIElpaWZSZXNvdXJjZSxcbn0gZnJvbSAnLi8uLi8uLi9tb2RlbHMvaWlpZi1zZWFyY2gtcmVzdWx0JztcbmltcG9ydCB7IENhbnZhcywgTWFuaWZlc3QsIFNlcXVlbmNlIH0gZnJvbSAnLi8uLi8uLi9tb2RlbHMvbWFuaWZlc3QnO1xuaW1wb3J0IHsgU2VhcmNoUmVzdWx0IH0gZnJvbSAnLi8uLi8uLi9tb2RlbHMvc2VhcmNoLXJlc3VsdCc7XG5cbmV4cG9ydCBjbGFzcyBTZWFyY2hSZXN1bHRCdWlsZGVyIHtcbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSBxOiBzdHJpbmcsXG4gICAgcHJpdmF0ZSBtYW5pZmVzdDogTWFuaWZlc3QsXG4gICAgcHJpdmF0ZSBpaWlmU2VhcmNoUmVzdWx0OiBJaWlmU2VhcmNoUmVzdWx0LFxuICAgIHByaXZhdGUgY29uZmlnOiBNaW1lVmlld2VyQ29uZmlnXG4gICkge31cblxuICBwdWJsaWMgYnVpbGQoKTogU2VhcmNoUmVzdWx0IHtcbiAgICBjb25zdCBzZWFyY2hSZXN1bHQgPSBuZXcgU2VhcmNoUmVzdWx0KCk7XG4gICAgc2VhcmNoUmVzdWx0LnEgPSB0aGlzLnE7XG4gICAgaWYgKHRoaXMuaWlpZlNlYXJjaFJlc3VsdCAmJiB0aGlzLmlpaWZTZWFyY2hSZXN1bHQuaGl0cykge1xuICAgICAgdGhpcy5paWlmU2VhcmNoUmVzdWx0LmhpdHMuZm9yRWFjaCgoaGl0OiBJaWlmSGl0LCBpbmRleDogbnVtYmVyKSA9PiB7XG4gICAgICAgIGNvbnN0IGlkOiBudW1iZXIgPSBpbmRleDtcbiAgICAgICAgbGV0IHN0YXJ0Q2FudmFzSW5kZXggPSAtMTtcbiAgICAgICAgbGV0IGxhYmVsO1xuICAgICAgICBjb25zdCBoaWdobGlnaHRSZWN0czogSGlnaGxpZ2h0UmVjdFtdID0gW107XG4gICAgICAgIGlmICh0aGlzLm1hbmlmZXN0LnNlcXVlbmNlcyAmJiB0aGlzLm1hbmlmZXN0LnNlcXVlbmNlc1swXS5jYW52YXNlcykge1xuICAgICAgICAgIGNvbnN0IHJlc291cmNlcyA9IHRoaXMuZmluZFJlc291cmNlcyhoaXQpO1xuICAgICAgICAgIHJlc291cmNlcy5mb3JFYWNoKChyZXNvdXJjZSwgaW5kZXgpID0+IHtcbiAgICAgICAgICAgIGlmIChpbmRleCA9PT0gMCkge1xuICAgICAgICAgICAgICBzdGFydENhbnZhc0luZGV4ID0gdGhpcy5maW5kU2VxdWVuY2VJbmRleChyZXNvdXJjZSk7XG4gICAgICAgICAgICAgIGxhYmVsID0gdGhpcy5maW5kTGFiZWwoc3RhcnRDYW52YXNJbmRleCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBjb25zdCBjYW52YXNJbmRleCA9IHRoaXMuZmluZFNlcXVlbmNlSW5kZXgocmVzb3VyY2UpO1xuICAgICAgICAgICAgY29uc3Qgb24gPSByZXNvdXJjZS5vbjtcbiAgICAgICAgICAgIGlmIChvbikge1xuICAgICAgICAgICAgICBjb25zdCBzY2FsZSA9IHRoaXMuZ2V0U2NhbGUoY2FudmFzSW5kZXgpO1xuICAgICAgICAgICAgICBjb25zdCBjb29yZHMgPSBvbi5zdWJzdHJpbmcob24uaW5kZXhPZignPScpICsgMSkuc3BsaXQoJywnKTtcbiAgICAgICAgICAgICAgY29uc3QgcmVjdCA9IG5ldyBIaWdobGlnaHRSZWN0KHtcbiAgICAgICAgICAgICAgICB4OiB0aGlzLnNjYWxlVmFsdWUoY29vcmRzWzBdLCBzY2FsZSksXG4gICAgICAgICAgICAgICAgeTogdGhpcy5zY2FsZVZhbHVlKGNvb3Jkc1sxXSwgc2NhbGUpLFxuICAgICAgICAgICAgICAgIHdpZHRoOiB0aGlzLnNjYWxlVmFsdWUoY29vcmRzWzJdLCBzY2FsZSksXG4gICAgICAgICAgICAgICAgaGVpZ2h0OiB0aGlzLnNjYWxlVmFsdWUoY29vcmRzWzNdLCBzY2FsZSksXG4gICAgICAgICAgICAgICAgY2FudmFzSW5kZXhcbiAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgIGhpZ2hsaWdodFJlY3RzLnB1c2gocmVjdCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfSk7XG4gICAgICAgIH1cblxuICAgICAgICBzZWFyY2hSZXN1bHQuYWRkKFxuICAgICAgICAgIG5ldyBIaXQoe1xuICAgICAgICAgICAgaWQ6IGlkLFxuICAgICAgICAgICAgaW5kZXg6IHN0YXJ0Q2FudmFzSW5kZXgsXG4gICAgICAgICAgICBsYWJlbDogbGFiZWwsXG4gICAgICAgICAgICBtYXRjaDogaGl0Lm1hdGNoLFxuICAgICAgICAgICAgYmVmb3JlOiBoaXQuYmVmb3JlLFxuICAgICAgICAgICAgYWZ0ZXI6IGhpdC5hZnRlcixcbiAgICAgICAgICAgIGhpZ2hsaWdodFJlY3RzLFxuICAgICAgICAgIH0pXG4gICAgICAgICk7XG4gICAgICB9KTtcbiAgICB9XG4gICAgcmV0dXJuIHNlYXJjaFJlc3VsdDtcbiAgfVxuXG4gIHByaXZhdGUgZmluZFJlc291cmNlcyhoaXQ6IElpaWZIaXQpOiBJaWlmUmVzb3VyY2VbXSB7XG4gICAgY29uc3QgcmVzb3VyY2VzOiBJaWlmUmVzb3VyY2VbXSA9IFtdO1xuICAgIGlmIChoaXQuYW5ub3RhdGlvbnMpIHtcbiAgICAgIGZvciAoY29uc3QgYW5ub3RhdGlvbiBvZiBoaXQuYW5ub3RhdGlvbnMpIHtcbiAgICAgICAgaWYgKHRoaXMuaWlpZlNlYXJjaFJlc3VsdC5yZXNvdXJjZXMpIHtcbiAgICAgICAgICBjb25zdCByZXMgPSB0aGlzLmlpaWZTZWFyY2hSZXN1bHQucmVzb3VyY2VzLmZpbmQoXG4gICAgICAgICAgICAocjogSWlpZlJlc291cmNlKSA9PiByWydAaWQnXSA9PT0gYW5ub3RhdGlvblxuICAgICAgICAgICk7XG4gICAgICAgICAgaWYgKHJlcykge1xuICAgICAgICAgICAgcmVzb3VyY2VzLnB1c2gocmVzKTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIHJlc291cmNlcztcbiAgfVxuXG4gIHByaXZhdGUgZmluZFNlcXVlbmNlSW5kZXgocmVzb3VyY2U6IElpaWZSZXNvdXJjZSk6IG51bWJlciB7XG4gICAgaWYgKCF0aGlzLm1hbmlmZXN0LnNlcXVlbmNlcykge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKCdObyBzZXF1ZW5jZXMgZm91bmQhJyk7XG4gICAgfVxuICAgIGNvbnN0IGZpcnN0U2VxdWVuY2UgPSB0aGlzLmdldEZpcnN0U2VxdWVuY2UoKTtcbiAgICBjb25zdCBvbiA9IHJlc291cmNlLm9uO1xuICAgIGlmIChvbiAmJiBmaXJzdFNlcXVlbmNlICYmIGZpcnN0U2VxdWVuY2UuY2FudmFzZXMpIHtcbiAgICAgIGNvbnN0IGlkID0gb24uc3Vic3RyaW5nKDAsIG9uLmluZGV4T2YoJyMnKSk7XG4gICAgICByZXR1cm4gZmlyc3RTZXF1ZW5jZS5jYW52YXNlcy5maW5kSW5kZXgoKGMpID0+IGMuaWQgPT09IGlkKTtcbiAgICB9XG4gICAgcmV0dXJuIC0xO1xuICB9XG5cbiAgcHJpdmF0ZSBmaW5kTGFiZWwoaW5kZXg6IG51bWJlcik6IHN0cmluZyB8IHVuZGVmaW5lZCB7XG4gICAgaWYgKGluZGV4ID09PSAtMSkge1xuICAgICAgcmV0dXJuIHVuZGVmaW5lZDtcbiAgICB9IGVsc2Uge1xuICAgICAgY29uc3QgY2FudmFzID0gdGhpcy5nZXRGaXJzdFNlcXVlbmNlQ2FudmFzKGluZGV4KTtcbiAgICAgIHJldHVybiBjYW52YXMgPyBjYW52YXMubGFiZWwgOiB1bmRlZmluZWQ7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBnZXRGaXJzdFNlcXVlbmNlKCk6IFNlcXVlbmNlIHwgdW5kZWZpbmVkIHtcbiAgICBjb25zdCBzZXF1ZW5jZXMgPSB0aGlzLm1hbmlmZXN0LnNlcXVlbmNlcztcbiAgICByZXR1cm4gc2VxdWVuY2VzID8gc2VxdWVuY2VzWzBdIDogdW5kZWZpbmVkO1xuICB9XG5cbiAgcHJpdmF0ZSBnZXRGaXJzdFNlcXVlbmNlQ2FudmFzKGluZGV4OiBudW1iZXIpOiBDYW52YXMgfCB1bmRlZmluZWQge1xuICAgIGNvbnN0IGZpcnN0U2VxdWVuY2UgPSB0aGlzLmdldEZpcnN0U2VxdWVuY2UoKTtcbiAgICByZXR1cm4gZmlyc3RTZXF1ZW5jZSAmJiBmaXJzdFNlcXVlbmNlLmNhbnZhc2VzICE9PSB1bmRlZmluZWRcbiAgICAgID8gZmlyc3RTZXF1ZW5jZS5jYW52YXNlc1tpbmRleF1cbiAgICAgIDogdW5kZWZpbmVkO1xuICB9XG5cbiAgcHJpdmF0ZSBnZXRTY2FsZShpbmRleDogbnVtYmVyKTogbnVtYmVyIHtcbiAgICBjb25zdCBwaHlzaWNhbFNjYWxlID0gdGhpcy5nZXRQaHlzaWNhbFNjYWxlKGluZGV4KTtcbiAgICByZXR1cm4gVXRpbHMuZ2V0U2NhbGVGYWN0b3IoXG4gICAgICBwaHlzaWNhbFNjYWxlLFxuICAgICAgdGhpcy5jb25maWc/Lmlnbm9yZVBoeXNpY2FsU2NhbGVcbiAgICApO1xuICB9XG5cbiAgcHJpdmF0ZSBnZXRQaHlzaWNhbFNjYWxlKGluZGV4OiBudW1iZXIpOiBudW1iZXIgfCB1bmRlZmluZWQge1xuICAgIGNvbnN0IGNhbnZhcyA9IHRoaXMuZ2V0Rmlyc3RTZXF1ZW5jZUNhbnZhcyhpbmRleCk7XG4gICAgcmV0dXJuIGNhbnZhcz8uaW1hZ2VzPy5bMF0ucmVzb3VyY2U/LnNlcnZpY2U/LnNlcnZpY2U/LnBoeXNpY2FsU2NhbGU7XG4gIH1cblxuICBwcml2YXRlIHNjYWxlVmFsdWUodmFsdWU6IHN0cmluZywgc2NhbGU6IG51bWJlcik6IG51bWJlciB7XG4gICAgcmV0dXJuIE1hdGgudHJ1bmMocGFyc2VJbnQodmFsdWUsIDEwKSAqIHNjYWxlKTtcbiAgfVxufVxuIl19