import { Injectable } from '@angular/core';
import { CanvasService } from '../../canvas-service/canvas-service';
import { IiifContentSearchService } from '../../iiif-content-search-service/iiif-content-search.service';
export class ContentSearchNavigationService {
    constructor(canvasService, iiifContentSearchService) {
        this.canvasService = canvasService;
        this.iiifContentSearchService = iiifContentSearchService;
        this.currentIndex = 0;
        this.isHitOnActiveCanvasGroup = false;
        this._isFirstHitOnCanvasGroup = false;
        this._isLastHitOnCanvasGroup = false;
        this.canvasesPerCanvasGroup = [-1];
        this.iiifContentSearchService.onChange.subscribe((result) => {
            this.searchResult = result;
        });
    }
    update(canvasGroupIndex) {
        this.canvasesPerCanvasGroup = this.canvasService.getCanvasesPerCanvasGroup(canvasGroupIndex);
        this.currentIndex = this.findCurrentHitIndex(this.canvasesPerCanvasGroup);
        this.isHitOnActiveCanvasGroup = this.findHitOnActiveCanvasGroup();
        this._isFirstHitOnCanvasGroup = this.isFirstHitOnCanvasGroup();
        this._isLastHitOnCanvasGroup = this.findLastHitOnCanvasGroup();
    }
    getCurrentIndex() {
        return this.currentIndex;
    }
    getHitOnActiveCanvasGroup() {
        return this.isHitOnActiveCanvasGroup;
    }
    getFirstHitCanvasGroup() {
        return this._isFirstHitOnCanvasGroup;
    }
    getLastHitCanvasGroup() {
        return this._isLastHitOnCanvasGroup;
    }
    goToNextCanvasGroupHit() {
        if (!this._isLastHitOnCanvasGroup) {
            let nextHit;
            if (this.currentIndex === -1) {
                nextHit = this.searchResult.get(0);
            }
            else {
                const current = this.searchResult.get(this.currentIndex);
                const canvasGroup = this.canvasService.findCanvasGroupByCanvasIndex(current.index);
                const canvasesPerCanvasGroup = this.canvasService.getCanvasesPerCanvasGroup(canvasGroup);
                const lastCanvasGroupIndex = this.getLastCanvasGroupIndex(canvasesPerCanvasGroup);
                nextHit = this.searchResult.hits.find(h => h.index > lastCanvasGroupIndex);
            }
            if (nextHit) {
                this.goToCanvasIndex(nextHit);
            }
        }
    }
    goToPreviousCanvasGroupHit() {
        const previousIndex = this.isHitOnActiveCanvasGroup
            ? this.currentIndex - 1
            : this.currentIndex;
        const previousHit = this.findFirstHitOnCanvasGroup(previousIndex);
        this.goToCanvasIndex(previousHit);
    }
    goToCanvasIndex(hit) {
        this.currentIndex = this.findCurrentHitIndex([hit.index]);
        this.iiifContentSearchService.selected(hit);
    }
    findLastHitOnCanvasGroup() {
        const lastCanvasIndex = this.searchResult.get(this.searchResult.size() - 1)
            .index;
        const currentHit = this.searchResult.get(this.currentIndex);
        return currentHit.index === lastCanvasIndex;
    }
    findFirstHitOnCanvasGroup(previousIndex) {
        let previousHit = this.searchResult.get(previousIndex);
        const canvasGroupIndex = this.canvasService.findCanvasGroupByCanvasIndex(previousHit.index);
        const canvasesPerCanvasGroup = this.canvasService.getCanvasesPerCanvasGroup(canvasGroupIndex);
        const leftCanvas = canvasesPerCanvasGroup[0];
        const leftCanvasHit = this.searchResult.hits.find(h => h.index === leftCanvas);
        if (leftCanvasHit) {
            previousHit = leftCanvasHit;
        }
        else if (canvasesPerCanvasGroup.length === 2) {
            const rightCanvas = canvasesPerCanvasGroup[1];
            previousHit = this.searchResult.hits.find(h => h.index === rightCanvas);
        }
        return previousHit;
    }
    findHitOnActiveCanvasGroup() {
        return (this.canvasesPerCanvasGroup.indexOf(this.searchResult.get(this.currentIndex).index) >= 0);
    }
    findCurrentHitIndex(canvasGroupIndexes) {
        for (let i = 0; i < this.searchResult.size(); i++) {
            const hit = this.searchResult.get(i);
            if (canvasGroupIndexes.indexOf(hit.index) >= 0) {
                return i;
            }
            if (hit.index >= canvasGroupIndexes[canvasGroupIndexes.length - 1]) {
                if (i === 0) {
                    return -1;
                }
                else {
                    const phit = this.searchResult.get(i - 1);
                    return this.searchResult.hits.findIndex(sr => sr.index === phit.index);
                }
            }
        }
        return this.searchResult.size() - 1;
    }
    isFirstHitOnCanvasGroup() {
        return this.currentIndex <= 0;
    }
    getLastCanvasGroupIndex(canvasesPerCanvasGroup) {
        return canvasesPerCanvasGroup.length === 1
            ? canvasesPerCanvasGroup[0]
            : canvasesPerCanvasGroup[1];
    }
}
ContentSearchNavigationService.decorators = [
    { type: Injectable }
];
ContentSearchNavigationService.ctorParameters = () => [
    { type: CanvasService },
    { type: IiifContentSearchService }
];
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29udGVudC1zZWFyY2gtbmF2aWdhdGlvbi5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6Ii4uLy4uLy4uLy4uLy4uL2xpYnMvbmd4LW1pbWUvc3JjLyIsInNvdXJjZXMiOlsibGliL2NvcmUvbmF2aWdhdGlvbi9jb250ZW50LXNlYXJjaC1uYXZpZ2F0aW9uLXNlcnZpY2UvY29udGVudC1zZWFyY2gtbmF2aWdhdGlvbi5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFFM0MsT0FBTyxFQUFFLGFBQWEsRUFBRSxNQUFNLHFDQUFxQyxDQUFDO0FBQ3BFLE9BQU8sRUFBRSx3QkFBd0IsRUFBRSxNQUFNLCtEQUErRCxDQUFDO0FBS3pHLE1BQU0sT0FBTyw4QkFBOEI7SUFRekMsWUFDVSxhQUE0QixFQUM1Qix3QkFBa0Q7UUFEbEQsa0JBQWEsR0FBYixhQUFhLENBQWU7UUFDNUIsNkJBQXdCLEdBQXhCLHdCQUF3QixDQUEwQjtRQVRwRCxpQkFBWSxHQUFHLENBQUMsQ0FBQztRQUNqQiw2QkFBd0IsR0FBRyxLQUFLLENBQUM7UUFDakMsNkJBQXdCLEdBQUcsS0FBSyxDQUFDO1FBQ2pDLDRCQUF1QixHQUFHLEtBQUssQ0FBQztRQUNoQywyQkFBc0IsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFPcEMsSUFBSSxDQUFDLHdCQUF3QixDQUFDLFFBQVEsQ0FBQyxTQUFTLENBQUMsQ0FBQyxNQUFvQixFQUFFLEVBQUU7WUFDeEUsSUFBSSxDQUFDLFlBQVksR0FBRyxNQUFNLENBQUM7UUFDN0IsQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDO0lBRUQsTUFBTSxDQUFDLGdCQUF3QjtRQUM3QixJQUFJLENBQUMsc0JBQXNCLEdBQUcsSUFBSSxDQUFDLGFBQWEsQ0FBQyx5QkFBeUIsQ0FDeEUsZ0JBQWdCLENBQ2pCLENBQUM7UUFDRixJQUFJLENBQUMsWUFBWSxHQUFHLElBQUksQ0FB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ZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdGFibGUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcblxuaW1wb3J0IHsgQ2FudmFzU2VydmljZSB9IGZyb20gJy4uLy4uL2NhbnZhcy1zZXJ2aWNlL2NhbnZhcy1zZXJ2aWNlJztcbmltcG9ydCB7IElpaWZDb250ZW50U2VhcmNoU2VydmljZSB9IGZyb20gJy4uLy4uL2lpaWYtY29udGVudC1zZWFyY2gtc2VydmljZS9paWlmLWNvbnRlbnQtc2VhcmNoLnNlcnZpY2UnO1xuaW1wb3J0IHsgU2VhcmNoUmVzdWx0IH0gZnJvbSAnLi4vLi4vbW9kZWxzL3NlYXJjaC1yZXN1bHQnO1xuaW1wb3J0IHsgSGl0IH0gZnJvbSAnLi4vLi4vbW9kZWxzL2hpdCc7XG5cbkBJbmplY3RhYmxlKClcbmV4cG9ydCBjbGFzcyBDb250ZW50U2VhcmNoTmF2aWdhdGlvblNlcnZpY2Uge1xuICBwcml2YXRlIGN1cnJlbnRJbmRleCA9IDA7XG4gIHByaXZhdGUgaXNIaXRPbkFjdGl2ZUNhbnZhc0dyb3VwID0gZmFsc2U7XG4gIHByaXZhdGUgX2lzRmlyc3RIaXRPbkNhbnZhc0dyb3VwID0gZmFsc2U7XG4gIHByaXZhdGUgX2lzTGFzdEhpdE9uQ2FudmFzR3JvdXAgPSBmYWxzZTtcbiAgcHJpdmF0ZSBjYW52YXNlc1BlckNhbnZhc0dyb3VwID0gWy0xXTtcbiAgcHJpdmF0ZSBzZWFyY2hSZXN1bHQ6IFNlYXJjaFJlc3VsdDtcblxuICBjb25zdHJ1Y3RvcihcbiAgICBwcml2YXRlIGNhbnZhc1NlcnZpY2U6IENhbnZhc1NlcnZpY2UsXG4gICAgcHJpdmF0ZSBpaWlmQ29udGVudFNlYXJjaFNlcnZpY2U6IElpaWZDb250ZW50U2VhcmNoU2VydmljZVxuICApIHtcbiAgICB0aGlzLmlpaWZDb250ZW50U2VhcmNoU2VydmljZS5vbkNoYW5nZS5zdWJzY3JpYmUoKHJlc3VsdDogU2VhcmNoUmVzdWx0KSA9PiB7XG4gICAgICB0aGlzLnNlYXJjaFJlc3VsdCA9IHJlc3VsdDtcbiAgICB9KTtcbiAgfVxuXG4gIHVwZGF0ZShjYW52YXNHcm91cEluZGV4OiBudW1iZXIpIHtcbiAgICB0aGlzLmNhbnZhc2VzUGVyQ2FudmFzR3JvdXAgPSB0aGlzLmNhbnZhc1NlcnZpY2UuZ2V0Q2FudmFzZXNQZXJDYW52YXNHcm91cChcbiAgICAgIGNhbnZhc0dyb3VwSW5kZXhcbiAgICApO1xuICAgIHRoaXMuY3VycmVudEluZGV4ID0gdGhpcy5maW5kQ3VycmVudEhpdEluZGV4KHRoaXMuY2FudmFzZXNQZXJDYW52YXNHcm91cCk7XG4gICAgdGhpcy5pc0hpdE9uQWN0aXZlQ2FudmFzR3JvdXAgPSB0aGlzLmZpbmRIaXRPbkFjdGl2ZUNhbnZhc0dyb3VwKCk7XG4gICAgdGhpcy5faXNGaXJzdEhpdE9uQ2FudmFzR3JvdXAgPSB0aGlzLmlzRmlyc3RIaXRPbkNhbnZhc0dyb3VwKCk7XG4gICAgdGhpcy5faXNMYXN0SGl0T25DYW52YXNHcm91cCA9IHRoaXMuZmluZExhc3RIaXRPbkNhbnZhc0dyb3VwKCk7XG4gIH1cblxuICBnZXRDdXJyZW50SW5kZXgoKTogbnVtYmVyIHtcbiAgICByZXR1cm4gdGhpcy5jdXJyZW50SW5kZXg7XG4gIH1cblxuICBnZXRIaXRPbkFjdGl2ZUNhbnZhc0dyb3VwKCk6IGJvb2xlYW4ge1xuICAgIHJldHVybiB0aGlzLmlzSGl0T25BY3RpdmVDYW52YXNHcm91cDtcbiAgfVxuXG4gIGdldEZpcnN0SGl0Q2FudmFzR3JvdXAoKTogYm9vbGVhbiB7XG4gICAgcmV0dXJuIHRoaXMuX2lzRmlyc3RIaXRPbkNhbnZhc0dyb3VwO1xuICB9XG5cbiAgZ2V0TGFzdEhpdENhbnZhc0dyb3VwKCk6IGJvb2xlYW4ge1xuICAgIHJldHVybiB0aGlzLl9pc0xhc3RIaXRPbkNhbnZhc0dyb3VwO1xuICB9XG5cbiAgZ29Ub05leHRDYW52YXNHcm91cEhpdCgpIHtcbiAgICBpZiAoIXRoaXMuX2lzTGFzdEhpdE9uQ2FudmFzR3JvdXApIHtcbiAgICAgIGxldCBuZXh0SGl0OiBIaXQ7XG4gICAgICBpZiAodGhpcy5jdXJyZW50SW5kZXggPT09IC0xKSB7XG4gICAgICAgIG5leHRIaXQgPSB0aGlzLnNlYXJjaFJlc3VsdC5nZXQoMCk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBjb25zdCBjdXJyZW50ID0gdGhpcy5zZWFyY2hSZXN1bHQuZ2V0KHRoaXMuY3VycmVudEluZGV4KTtcbiAgICAgICAgY29uc3QgY2FudmFzR3JvdXAgPSB0aGlzLmNhbnZhc1NlcnZpY2UuZmluZENhbnZhc0dyb3VwQnlDYW52YXNJbmRleChcbiAgICAgICAgICBjdXJyZW50LmluZGV4XG4gICAgICAgICk7XG4gICAgICAgIGNvbnN0IGNhbnZhc2VzUGVyQ2FudmFzR3JvdXAgPSB0aGlzLmNhbnZhc1NlcnZpY2UuZ2V0Q2FudmFzZXNQZXJDYW52YXNHcm91cChcbiAgICAgICAgICBjYW52YXNHcm91cFxuICAgICAgICApO1xuICAgICAgICBjb25zdCBsYXN0Q2FudmFzR3JvdXBJbmRleCA9IHRoaXMuZ2V0TGFzdENhbnZhc0dyb3VwSW5kZXgoXG4gICAgICAgICAgY2FudmFzZXNQZXJDYW52YXNHcm91cFxuICAgICAgICApO1xuICAgICAgICBuZXh0SGl0ID0gdGhpcy5zZWFyY2hSZXN1bHQuaGl0cy5maW5kKFxuICAgICAgICAgIGggPT4gaC5pbmRleCA+IGxhc3RDYW52YXNHcm91cEluZGV4XG4gICAgICAgICk7XG4gICAgICB9XG4gICAgICBpZiAobmV4dEhpdCkge1xuICAgICAgICB0aGlzLmdvVG9DYW52YXNJbmRleChuZXh0SGl0KTtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBnb1RvUHJldmlvdXNDYW52YXNHcm91cEhpdCgpIHtcbiAgICBjb25zdCBwcmV2aW91c0luZGV4ID0gdGhpcy5pc0hpdE9uQWN0aXZlQ2FudmFzR3JvdXBcbiAgICAgID8gdGhpcy5jdXJyZW50SW5kZXggLSAxXG4gICAgICA6IHRoaXMuY3VycmVudEluZGV4O1xuICAgIGNvbnN0IHByZXZpb3VzSGl0ID0gdGhpcy5maW5kRmlyc3RIaXRPbkNhbnZhc0dyb3VwKHByZXZpb3VzSW5kZXgpO1xuICAgIHRoaXMuZ29Ub0NhbnZhc0luZGV4KHByZXZpb3VzSGl0KTtcbiAgfVxuXG4gIHByaXZhdGUgZ29Ub0NhbnZhc0luZGV4KGhpdDogSGl0KTogdm9pZCB7XG4gICAgdGhpcy5jdXJyZW50SW5kZXggPSB0aGlzLmZpbmRDdXJyZW50SGl0SW5kZXgoW2hpdC5pbmRleF0pO1xuICAgIHRoaXMuaWlpZkNvbnRlbnRTZWFyY2hTZXJ2aWNlLnNlbGVjdGVkKGhpdCk7XG4gIH1cblxuICBwcml2YXRlIGZpbmRMYXN0SGl0T25DYW52YXNHcm91cCgpIHtcbiAgICBjb25zdCBsYXN0Q2FudmFzSW5kZXggPSB0aGlzLnNlYXJjaFJlc3VsdC5nZXQodGhpcy5zZWFyY2hSZXN1bHQuc2l6ZSgpIC0gMSlcbiAgICAgIC5pbmRleDtcbiAgICBjb25zdCBjdXJyZW50SGl0ID0gdGhpcy5zZWFyY2hSZXN1bHQuZ2V0KHRoaXMuY3VycmVudEluZGV4KTtcbiAgICByZXR1cm4gY3VycmVudEhpdC5pbmRleCA9PT0gbGFzdENhbnZhc0luZGV4O1xuICB9XG5cbiAgcHJpdmF0ZSBmaW5kRmlyc3RIaXRPbkNhbnZhc0dyb3VwKHByZXZpb3VzSW5kZXg6IG51bWJlcik6IEhpdCB7XG4gICAgbGV0IHByZXZpb3VzSGl0ID0gdGhpcy5zZWFyY2hSZXN1bHQuZ2V0KHByZXZpb3VzSW5kZXgpO1xuICAgIGNvbnN0IGNhbnZhc0dyb3VwSW5kZXggPSB0aGlzLmNhbnZhc1NlcnZpY2UuZmluZENhbnZhc0dyb3VwQnlDYW52YXNJbmRleChcbiAgICAgIHByZXZpb3VzSGl0LmluZGV4XG4gICAgKTtcbiAgICBjb25zdCBjYW52YXNlc1BlckNhbnZhc0dyb3VwID0gdGhpcy5jYW52YXNTZXJ2aWNlLmdldENhbnZhc2VzUGVyQ2FudmFzR3JvdXAoXG4gICAgICBjYW52YXNHcm91cEluZGV4XG4gICAgKTtcbiAgICBjb25zdCBsZWZ0Q2FudmFzID0gY2FudmFzZXNQZXJDYW52YXNHcm91cFswXTtcbiAgICBjb25zdCBsZWZ0Q2FudmFzSGl0ID0gdGhpcy5zZWFyY2hSZXN1bHQuaGl0cy5maW5kKFxuICAgICAgaCA9PiBoLmluZGV4ID09PSBsZWZ0Q2FudmFzXG4gICAgKTtcbiAgICBpZiAobGVmdENhbnZhc0hpdCkge1xuICAgICAgcHJldmlvdXNIaXQgPSBsZWZ0Q2FudmFzSGl0O1xuICAgIH0gZWxzZSBpZiAoY2FudmFzZXNQZXJDYW52YXNHcm91cC5sZW5ndGggPT09IDIpIHtcbiAgICAgIGNvbnN0IHJpZ2h0Q2FudmFzID0gY2FudmFzZXNQZXJDYW52YXNHcm91cFsxXTtcbiAgICAgIHByZXZpb3VzSGl0ID0gdGhpcy5zZWFyY2hSZXN1bHQuaGl0cy5maW5kKGggPT4gaC5pbmRleCA9PT0gcmlnaHRDYW52YXMpO1xuICAgIH1cbiAgICByZXR1cm4gcHJldmlvdXNIaXQ7XG4gIH1cblxuICBwcml2YXRlIGZpbmRIaXRPbkFjdGl2ZUNhbnZhc0dyb3VwKCkge1xuICAgIHJldHVybiAoXG4gICAgICB0aGlzLmNhbnZhc2VzUGVyQ2FudmFzR3JvdXAuaW5kZXhPZihcbiAgICAgICAgdGhpcy5zZWFyY2hSZXN1bHQuZ2V0KHRoaXMuY3VycmVudEluZGV4KS5pbmRleFxuICAgICAgKSA+PSAwXG4gICAgKTtcbiAgfVxuXG4gIHByaXZhdGUgZmluZEN1cnJlbnRIaXRJbmRleChjYW52YXNHcm91cEluZGV4ZXM6IG51bWJlcltdKTogbnVtYmVyIHtcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHRoaXMuc2VhcmNoUmVzdWx0LnNpemUoKTsgaSsrKSB7XG4gICAgICBjb25zdCBoaXQgPSB0aGlzLnNlYXJjaFJlc3VsdC5nZXQoaSk7XG4gICAgICBpZiAoY2FudmFzR3JvdXBJbmRleGVzLmluZGV4T2YoaGl0LmluZGV4KSA+PSAwKSB7XG4gICAgICAgIHJldHVybiBpO1xuICAgICAgfVxuICAgICAgaWYgKGhpdC5pbmRleCA+PSBjYW52YXNHcm91cEluZGV4ZXNbY2FudmFzR3JvdXBJbmRleGVzLmxlbmd0aCAtIDFdKSB7XG4gICAgICAgIGlmIChpID09PSAwKSB7XG4gICAgICAgICAgcmV0dXJuIC0xO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIGNvbnN0IHBoaXQgPSB0aGlzLnNlYXJjaFJlc3VsdC5nZXQoaSAtIDEpO1xuICAgICAgICAgIHJldHVybiB0aGlzLnNlYXJjaFJlc3VsdC5oaXRzLmZpbmRJbmRleChcbiAgICAgICAgICAgIHNyID0+IHNyLmluZGV4ID09PSBwaGl0LmluZGV4XG4gICAgICAgICAgKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gdGhpcy5zZWFyY2hSZXN1bHQuc2l6ZSgpIC0gMTtcbiAgfVxuXG4gIHByaXZhdGUgaXNGaXJzdEhpdE9uQ2FudmFzR3JvdXAoKSB7XG4gICAgcmV0dXJuIHRoaXMuY3VycmVudEluZGV4IDw9IDA7XG4gIH1cblxuICBwcml2YXRlIGdldExhc3RDYW52YXNHcm91cEluZGV4KGNhbnZhc2VzUGVyQ2FudmFzR3JvdXA6IG51bWJlcltdKSB7XG4gICAgcmV0dXJuIGNhbnZhc2VzUGVyQ2FudmFzR3JvdXAubGVuZ3RoID09PSAxXG4gICAgICA/IGNhbnZhc2VzUGVyQ2FudmFzR3JvdXBbMF1cbiAgICAgIDogY2FudmFzZXNQZXJDYW52YXNHcm91cFsxXTtcbiAgfVxufVxuIl19