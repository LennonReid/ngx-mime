import { Utils } from '../utils';
import { Hit } from './../models/hit';
import { Rect } from './../models/rect';
import { SearchResult } from './../models/search-result';
export class SearchResultBuilder {
    constructor(q, manifest, iiifSearchResult, config) {
        this.q = q;
        this.manifest = manifest;
        this.iiifSearchResult = iiifSearchResult;
        this.config = config;
    }
    build() {
        const searchResult = new SearchResult();
        searchResult.q = this.q;
        if (this.iiifSearchResult && this.iiifSearchResult.hits) {
            this.iiifSearchResult.hits.forEach((hit, index) => {
                const id = index;
                let canvasIndex = -1;
                let label;
                const rects = [];
                if (this.manifest.sequences && this.manifest.sequences[0].canvases) {
                    const resources = this.findResources(hit);
                    for (const resource of resources) {
                        canvasIndex = this.findSequenceIndex(resource);
                        label = this.findLabel(canvasIndex);
                        const on = resource.on;
                        if (on) {
                            const scale = this.getScale(canvasIndex);
                            const coords = on.substring(on.indexOf('=') + 1).split(',');
                            const rect = new Rect({
                                x: this.scaleValue(coords[0], scale),
                                y: this.scaleValue(coords[1], scale),
                                width: this.scaleValue(coords[2], scale),
                                height: this.scaleValue(coords[3], scale),
                            });
                            rects.push(rect);
                        }
                    }
                }
                searchResult.add(new Hit({
                    id: id,
                    index: canvasIndex,
                    label: label,
                    match: hit.match,
                    before: hit.before,
                    after: hit.after,
                    rects: rects,
                }));
            });
        }
        return searchResult;
    }
    findResources(hit) {
        const resources = [];
        if (hit.annotations) {
            for (const annotation of hit.annotations) {
                if (this.iiifSearchResult.resources) {
                    const res = this.iiifSearchResult.resources.find((r) => r['@id'] === annotation);
                    if (res) {
                        resources.push(res);
                    }
                }
            }
        }
        return resources;
    }
    findSequenceIndex(resource) {
        if (!this.manifest.sequences) {
            throw new Error('No sequences found!');
        }
        const firstSequence = this.getFirstSequence();
        const on = resource.on;
        if (on && firstSequence && firstSequence.canvases) {
            const id = on.substring(0, on.indexOf('#'));
            return firstSequence.canvases.findIndex((c) => c.id === id);
        }
        return -1;
    }
    findLabel(index) {
        if (index === -1) {
            return undefined;
        }
        else {
            const canvas = this.getFirstSequenceCanvas(index);
            return canvas ? canvas.label : undefined;
        }
    }
    getFirstSequence() {
        const sequences = this.manifest.sequences;
        return sequences ? sequences[0] : undefined;
    }
    getFirstSequenceCanvas(index) {
        const firstSequence = this.getFirstSequence();
        return firstSequence && firstSequence.canvases !== undefined
            ? firstSequence.canvases[index]
            : undefined;
    }
    getScale(index) {
        const physicalScale = this.getPhysicalScale(index);
        return Utils.getScaleFactor(physicalScale, this.config.ignorePhysicalScale);
    }
    getPhysicalScale(index) {
        const canvas = this.getFirstSequenceCanvas(index);
        return canvas?.images?.[0].resource?.service?.service?.physicalScale;
    }
    scaleValue(value, scale) {
        return Math.trunc(parseInt(value, 10) * scale);
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2VhcmNoLXJlc3VsdC5idWlsZGVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vLi4vLi4vbGlicy9uZ3gtbWltZS9zcmMvbGliL2NvcmUvYnVpbGRlcnMvc2VhcmNoLXJlc3VsdC5idWlsZGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUNBLE9BQU8sRUFBRSxLQUFLLEVBQUUsTUFBTSxVQUFVLENBQUM7QUFDakMsT0FBTyxFQUFFLEdBQUcsRUFBRSxNQUFNLGlCQUFpQixDQUFDO0FBT3RDLE9BQU8sRUFBRSxJQUFJLEVBQUUsTUFBTSxrQkFBa0IsQ0FBQztBQUN4QyxPQUFPLEVBQUUsWUFBWSxFQUFFLE1BQU0sMkJBQTJCLENBQUM7QUFFekQsTUFBTSxPQUFPLG1CQUFtQjtJQUM5QixZQUNVLENBQVMsRUFDVCxRQUFrQixFQUNsQixnQkFBa0MsRUFDbEMsTUFBd0I7UUFIeEIsTUFBQyxHQUFELENBQUMsQ0FBUTtRQUNULGFBQVEsR0FBUixRQUFRLENBQVU7UUFDbEIscUJBQWdCLEdBQWhCLGdCQUFnQixDQUFrQjtRQUNsQyxXQUFNLEdBQU4sTUFBTSxDQUFrQjtJQUMvQixDQUFDO0lBRUcsS0FBSztRQUNWLE1BQU0sWUFBWSxHQUFHLElBQUksWUFBWSxFQUFFLENBQUM7UUFDeEMsWUFBWSxDQUFDLENBQUMsR0FBRyxJQUFJLENBQUMsQ0FBQyxDQUFDO1FBQ3hCLElBQUksSUFBSSxDQUFDLGdCQUFnQixJQUFJLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxJQUFJLEVBQUU7WUFDdkQsSUFBSSxDQUFDLGdCQUFnQixDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQyxHQUFZLEVBQUUsS0FBYSxFQUFFLEVBQUU7Z0JBQ2pFLE1BQU0sRUFBRSxHQUFXLEtBQUssQ0FBQztnQkFDekIsSUFBSSxXQUFXLEdBQUcsQ0FBQyxDQUFDLENBQUM7Z0JBQ3JCLElBQUksS0FBSyxDQUFDO2dCQUNWLE1BQU0sS0FBSyxHQUFX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WUFDL0IsQ0FBQyxDQUFDLFNBQVMsQ0FBQztJQUNoQixDQUFDO0lBRU8sUUFBUSxDQUFDLEtBQWE7UUFDNUIsTUFBTSxhQUFhLEdBQUcsSUFBSSxDQUFDLGdCQUFnQixDQUFDLEtBQUssQ0FBQyxDQUFDO1FBQ25ELE9BQU8sS0FBSyxDQUFDLGNBQWMsQ0FBQyxhQUFhLEVBQUUsSUFBSSxDQUFDLE1BQU0sQ0FBQyxtQkFBbUIsQ0FBQyxDQUFDO0lBQzlFLENBQUM7SUFFTyxnQkFBZ0IsQ0FBQyxLQUFhO1FBQ3BDLE1BQU0sTUFBTSxHQUFHLElBQUksQ0FBQyxzQkFBc0IsQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUNsRCxPQUFPLE1BQU0sRUFBRSxNQUFNLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxRQUFRLEVBQUUsT0FBTyxFQUFFLE9BQU8sRUFBRSxhQUFhLENBQUM7SUFDdkUsQ0FBQztJQUVPLFVBQVUsQ0FBQyxLQUFhLEVBQUUsS0FBYTtRQUM3QyxPQUFPLElBQUksQ0FBQyxLQUFLLENBQUMsUUFBUSxDQUFDLEtBQUssRUFBRSxFQUFFLENBQUMsR0FBRyxLQUFLLENBQUMsQ0FBQztJQUNqRCxDQUFDO0NBQ0YiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBNaW1lVmlld2VyQ29uZmlnIH0gZnJvbSAnLi4vbWltZS12aWV3ZXItY29uZmlnJztcbmltcG9ydCB7IFV0aWxzIH0gZnJvbSAnLi4vdXRpbHMnO1xuaW1wb3J0IHsgSGl0IH0gZnJvbSAnLi8uLi9tb2RlbHMvaGl0JztcbmltcG9ydCB7XG4gIEhpdCBhcyBJaWlmSGl0LFxuICBJaWlmU2VhcmNoUmVzdWx0LFxuICBSZXNvdXJjZSBhcyBJaWlmUmVzb3VyY2UsXG59IGZyb20gJy4vLi4vbW9kZWxzL2lpaWYtc2VhcmNoLXJlc3VsdCc7XG5pbXBvcnQgeyBDYW52YXMsIE1hbmlmZXN0LCBTZXF1ZW5jZSB9IGZyb20gJy4vLi4vbW9kZWxzL21hbmlmZXN0JztcbmltcG9ydCB7IFJlY3QgfSBmcm9tICcuLy4uL21vZGVscy9yZWN0JztcbmltcG9ydCB7IFNlYXJjaFJlc3VsdCB9IGZyb20gJy4vLi4vbW9kZWxzL3NlYXJjaC1yZXN1bHQnO1xuXG5leHBvcnQgY2xhc3MgU2VhcmNoUmVzdWx0QnVpbGRlciB7XG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgcTogc3RyaW5nLFxuICAgIHByaXZhdGUgbWFuaWZlc3Q6IE1hbmlmZXN0LFxuICAgIHByaXZhdGUgaWlpZlNlYXJjaFJlc3VsdDogSWlpZlNlYXJjaFJlc3VsdCxcbiAgICBwcml2YXRlIGNvbmZpZzogTWltZVZpZXdlckNvbmZpZ1xuICApIHt9XG5cbiAgcHVibGljIGJ1aWxkKCk6IFNlYXJjaFJlc3VsdCB7XG4gICAgY29uc3Qgc2VhcmNoUmVzdWx0ID0gbmV3IFNlYXJjaFJlc3VsdCgpO1xuICAgIHNlYXJjaFJlc3VsdC5xID0gdGhpcy5xO1xuICAgIGlmICh0aGlzLmlpaWZTZWFyY2hSZXN1bHQgJiYgdGhpcy5paWlmU2VhcmNoUmVzdWx0LmhpdHMpIHtcbiAgICAgIHRoaXMuaWlpZlNlYXJjaFJlc3VsdC5oaXRzLmZvckVhY2goKGhpdDogSWlpZkhpdCwgaW5kZXg6IG51bWJlcikgPT4ge1xuICAgICAgICBjb25zdCBpZDogbnVtYmVyID0gaW5kZXg7XG4gICAgICAgIGxldCBjYW52YXNJbmRleCA9IC0xO1xuICAgICAgICBsZXQgbGFiZWw7XG4gICAgICAgIGNvbnN0IHJlY3RzOiBSZWN0W10gPSBbXTtcbiAgICAgICAgaWYgKHRoaXMubWFuaWZlc3Quc2VxdWVuY2VzICYmIHRoaXMubWFuaWZlc3Quc2VxdWVuY2VzWzBdLmNhbnZhc2VzKSB7XG4gICAgICAgICAgY29uc3QgcmVzb3VyY2VzID0gdGhpcy5maW5kUmVzb3VyY2VzKGhpdCk7XG4gICAgICAgICAgZm9yIChjb25zdCByZXNvdXJjZSBvZiByZXNvdXJjZXMpIHtcbiAgICAgICAgICAgIGNhbnZhc0luZGV4ID0gdGhpcy5maW5kU2VxdWVuY2VJbmRleChyZXNvdXJjZSk7XG4gICAgICAgICAgICBsYWJlbCA9IHRoaXMuZmluZExhYmVsKGNhbnZhc0luZGV4KTtcbiAgICAgICAgICAgIGNvbnN0IG9uID0gcmVzb3VyY2Uub247XG4gICAgICAgICAgICBpZiAob24pIHtcbiAgICAgICAgICAgICAgY29uc3Qgc2NhbGUgPSB0aGlzLmdldFNjYWxlKGNhbnZhc0luZGV4KTtcbiAgICAgICAgICAgICAgY29uc3QgY29vcmRzID0gb24uc3Vic3RyaW5nKG9uLmluZGV4T2YoJz0nKSArIDEpLnNwbGl0KCcsJyk7XG4gICAgICAgICAgICAgIGNvbnN0IHJlY3QgPSBuZXcgUmVjdCh7XG4gICAgICAgICAgICAgICAgeDogdGhpcy5zY2FsZVZhbHVlKGNvb3Jkc1swXSwgc2NhbGUpLFxuICAgICAgICAgICAgICAgIHk6IHRoaXMuc2NhbGVWYWx1ZShjb29yZHNbMV0sIHNjYWxlKSxcbiAgICAgICAgICAgICAgICB3aWR0aDogdGhpcy5zY2FsZVZhbHVlKGNvb3Jkc1syXSwgc2NhbGUpLFxuICAgICAgICAgICAgICAgIGhlaWdodDogdGhpcy5zY2FsZVZhbHVlKGNvb3Jkc1szXSwgc2NhbGUpLFxuICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgcmVjdHMucHVzaChyZWN0KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICBzZWFyY2hSZXN1bHQuYWRkKFxuICAgICAgICAgIG5ldyBIaXQoe1xuICAgICAgICAgICAgaWQ6IGlkLFxuICAgICAgICAgICAgaW5kZXg6IGNhbnZhc0luZGV4LFxuICAgICAgICAgICAgbGFiZWw6IGxhYmVsLFxuICAgICAgICAgICAgbWF0Y2g6IGhpdC5tYXRjaCxcbiAgICAgICAgICAgIGJlZm9yZTogaGl0LmJlZm9yZSxcbiAgICAgICAgICAgIGFmdGVyOiBoaXQuYWZ0ZXIsXG4gICAgICAgICAgICByZWN0czogcmVjdHMsXG4gICAgICAgICAgfSlcbiAgICAgICAgKTtcbiAgICAgIH0pO1xuICAgIH1cbiAgICByZXR1cm4gc2VhcmNoUmVzdWx0O1xuICB9XG5cbiAgcHJpdmF0ZSBmaW5kUmVzb3VyY2VzKGhpdDogSWlpZkhpdCk6IElpaWZSZXNvdXJjZVtdIHtcbiAgICBjb25zdCByZXNvdXJjZXM6IElpaWZSZXNvdXJjZVtdID0gW107XG4gICAgaWYgKGhpdC5hbm5vdGF0aW9ucykge1xuICAgICAgZm9yIChjb25zdCBhbm5vdGF0aW9uIG9mIGhpdC5hbm5vdGF0aW9ucykge1xuICAgICAgICBpZiAodGhpcy5paWlmU2VhcmNoUmVzdWx0LnJlc291cmNlcykge1xuICAgICAgICAgIGNvbnN0IHJlcyA9IHRoaXMuaWlpZlNlYXJjaFJlc3VsdC5yZXNvdXJjZXMuZmluZChcbiAgICAgICAgICAgIChyOiBJaWlmUmVzb3VyY2UpID0+IHJbJ0BpZCddID09PSBhbm5vdGF0aW9uXG4gICAgICAgICAgKTtcbiAgICAgICAgICBpZiAocmVzKSB7XG4gICAgICAgICAgICByZXNvdXJjZXMucHVzaChyZXMpO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gcmVzb3VyY2VzO1xuICB9XG5cbiAgcHJpdmF0ZSBmaW5kU2VxdWVuY2VJbmRleChyZXNvdXJjZTogSWlpZlJlc291cmNlKTogbnVtYmVyIHtcbiAgICBpZiAoIXRoaXMubWFuaWZlc3Quc2VxdWVuY2VzKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ05vIHNlcXVlbmNlcyBmb3VuZCEnKTtcbiAgICB9XG4gICAgY29uc3QgZmlyc3RTZXF1ZW5jZSA9IHRoaXMuZ2V0Rmlyc3RTZXF1ZW5jZSgpO1xuICAgIGNvbnN0IG9uID0gcmVzb3VyY2Uub247XG4gICAgaWYgKG9uICYmIGZpcnN0U2VxdWVuY2UgJiYgZmlyc3RTZXF1ZW5jZS5jYW52YXNlcykge1xuICAgICAgY29uc3QgaWQgPSBvbi5zdWJzdHJpbmcoMCwgb24uaW5kZXhPZignIycpKTtcbiAgICAgIHJldHVybiBmaXJzdFNlcXVlbmNlLmNhbnZhc2VzLmZpbmRJbmRleCgoYykgPT4gYy5pZCA9PT0gaWQpO1xuICAgIH1cbiAgICByZXR1cm4gLTE7XG4gIH1cblxuICBwcml2YXRlIGZpbmRMYWJlbChpbmRleDogbnVtYmVyKTogc3RyaW5nIHwgdW5kZWZpbmVkIHtcbiAgICBpZiAoaW5kZXggPT09IC0xKSB7XG4gICAgICByZXR1cm4gdW5kZWZpbmVkO1xuICAgIH0gZWxzZSB7XG4gICAgICBjb25zdCBjYW52YXMgPSB0aGlzLmdldEZpcnN0U2VxdWVuY2VDYW52YXMoaW5kZXgpO1xuICAgICAgcmV0dXJuIGNhbnZhcyA/IGNhbnZhcy5sYWJlbCA6IHVuZGVmaW5lZDtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGdldEZpcnN0U2VxdWVuY2UoKTogU2VxdWVuY2UgfCB1bmRlZmluZWQge1xuICAgIGNvbnN0IHNlcXVlbmNlcyA9IHRoaXMubWFuaWZlc3Quc2VxdWVuY2VzO1xuICAgIHJldHVybiBzZXF1ZW5jZXMgPyBzZXF1ZW5jZXNbMF0gOiB1bmRlZmluZWQ7XG4gIH1cblxuICBwcml2YXRlIGdldEZpcnN0U2VxdWVuY2VDYW52YXMoaW5kZXg6IG51bWJlcik6IENhbnZhcyB8IHVuZGVmaW5lZCB7XG4gICAgY29uc3QgZmlyc3RTZXF1ZW5jZSA9IHRoaXMuZ2V0Rmlyc3RTZXF1ZW5jZSgpO1xuICAgIHJldHVybiBmaXJzdFNlcXVlbmNlICYmIGZpcnN0U2VxdWVuY2UuY2FudmFzZXMgIT09IHVuZGVmaW5lZFxuICAgICAgPyBmaXJzdFNlcXVlbmNlLmNhbnZhc2VzW2luZGV4XVxuICAgICAgOiB1bmRlZmluZWQ7XG4gIH1cblxuICBwcml2YXRlIGdldFNjYWxlKGluZGV4OiBudW1iZXIpOiBudW1iZXIge1xuICAgIGNvbnN0IHBoeXNpY2FsU2NhbGUgPSB0aGlzLmdldFBoeXNpY2FsU2NhbGUoaW5kZXgpO1xuICAgIHJldHVybiBVdGlscy5nZXRTY2FsZUZhY3RvcihwaHlzaWNhbFNjYWxlLCB0aGlzLmNvbmZpZy5pZ25vcmVQaHlzaWNhbFNjYWxlKTtcbiAgfVxuXG4gIHByaXZhdGUgZ2V0UGh5c2ljYWxTY2FsZShpbmRleDogbnVtYmVyKTogbnVtYmVyIHwgdW5kZWZpbmVkIHtcbiAgICBjb25zdCBjYW52YXMgPSB0aGlzLmdldEZpcnN0U2VxdWVuY2VDYW52YXMoaW5kZXgpO1xuICAgIHJldHVybiBjYW52YXM/LmltYWdlcz8uWzBdLnJlc291cmNlPy5zZXJ2aWNlPy5zZXJ2aWNlPy5waHlzaWNhbFNjYWxlO1xuICB9XG5cbiAgcHJpdmF0ZSBzY2FsZVZhbHVlKHZhbHVlOiBzdHJpbmcsIHNjYWxlOiBudW1iZXIpOiBudW1iZXIge1xuICAgIHJldHVybiBNYXRoLnRydW5jKHBhcnNlSW50KHZhbHVlLCAxMCkgKiBzY2FsZSk7XG4gIH1cbn1cbiJdfQ==