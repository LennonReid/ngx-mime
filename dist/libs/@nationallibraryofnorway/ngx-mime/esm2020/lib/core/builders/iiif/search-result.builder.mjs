import { Utils } from '../../utils';
import { Hit } from './../../models/hit';
import { Rect } from './../../models/rect';
import { SearchResult } from './../../models/search-result';
export class SearchResultBuilder {
    constructor(q, manifest, iiifSearchResult, config) {
        this.q = q;
        this.manifest = manifest;
        this.iiifSearchResult = iiifSearchResult;
        this.config = config;
    }
    build() {
        const searchResult = new SearchResult();
        searchResult.q = this.q;
        if (this.iiifSearchResult && this.iiifSearchResult.hits) {
            this.iiifSearchResult.hits.forEach((hit, index) => {
                const id = index;
                let canvasIndex = -1;
                let label;
                const rects = [];
                if (this.manifest.sequences && this.manifest.sequences[0].canvases) {
                    const resources = this.findResources(hit);
                    for (const resource of resources) {
                        canvasIndex = this.findSequenceIndex(resource);
                        label = this.findLabel(canvasIndex);
                        const on = resource.on;
                        if (on) {
                            const scale = this.getScale(canvasIndex);
                            const coords = on.substring(on.indexOf('=') + 1).split(',');
                            const rect = new Rect({
                                x: this.scaleValue(coords[0], scale),
                                y: this.scaleValue(coords[1], scale),
                                width: this.scaleValue(coords[2], scale),
                                height: this.scaleValue(coords[3], scale),
                            });
                            rects.push(rect);
                        }
                    }
                }
                searchResult.add(new Hit({
                    id: id,
                    index: canvasIndex,
                    label: label,
                    match: hit.match,
                    before: hit.before,
                    after: hit.after,
                    rects: rects,
                }));
            });
        }
        return searchResult;
    }
    findResources(hit) {
        const resources = [];
        if (hit.annotations) {
            for (const annotation of hit.annotations) {
                if (this.iiifSearchResult.resources) {
                    const res = this.iiifSearchResult.resources.find((r) => r['@id'] === annotation);
                    if (res) {
                        resources.push(res);
                    }
                }
            }
        }
        return resources;
    }
    findSequenceIndex(resource) {
        if (!this.manifest.sequences) {
            throw new Error('No sequences found!');
        }
        const firstSequence = this.getFirstSequence();
        const on = resource.on;
        if (on && firstSequence && firstSequence.canvases) {
            const id = on.substring(0, on.indexOf('#'));
            return firstSequence.canvases.findIndex((c) => c.id === id);
        }
        return -1;
    }
    findLabel(index) {
        if (index === -1) {
            return undefined;
        }
        else {
            const canvas = this.getFirstSequenceCanvas(index);
            return canvas ? canvas.label : undefined;
        }
    }
    getFirstSequence() {
        const sequences = this.manifest.sequences;
        return sequences ? sequences[0] : undefined;
    }
    getFirstSequenceCanvas(index) {
        const firstSequence = this.getFirstSequence();
        return firstSequence && firstSequence.canvases !== undefined
            ? firstSequence.canvases[index]
            : undefined;
    }
    getScale(index) {
        const physicalScale = this.getPhysicalScale(index);
        return Utils.getScaleFactor(physicalScale, this.config?.ignorePhysicalScale);
    }
    getPhysicalScale(index) {
        const canvas = this.getFirstSequenceCanvas(index);
        return canvas?.images?.[0].resource?.service?.service?.physicalScale;
    }
    scaleValue(value, scale) {
        return Math.trunc(parseInt(value, 10) * scale);
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2VhcmNoLXJlc3VsdC5idWlsZGVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vLi4vLi4vLi4vbGlicy9uZ3gtbWltZS9zcmMvbGliL2NvcmUvYnVpbGRlcnMvaWlpZi9zZWFyY2gtcmVzdWx0LmJ1aWxkZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQ0EsT0FBTyxFQUFFLEtBQUssRUFBRSxNQUFNLGFBQWEsQ0FBQztBQUNwQyxPQUFPLEVBQUUsR0FBRyxFQUFFLE1BQU0sb0JBQW9CLENBQUM7QUFPekMsT0FBTyxFQUFFLElBQUksRUFBRSxNQUFNLHFCQUFxQixDQUFDO0FBQzNDLE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSw4QkFBOEIsQ0FBQztBQUU1RCxNQUFNLE9BQU8sbUJBQW1CO0lBQzlCLFlBQ1UsQ0FBUyxFQUNULFFBQWtCLEVBQ2xCLGdCQUFrQyxFQUNsQyxNQUF3QjtRQUh4QixNQUFDLEdBQUQsQ0FBQyxDQUFRO1FBQ1QsYUFBUSxHQUFSLFFBQVEsQ0FBVTtRQUNsQixxQkFBZ0IsR0FBaEIsZ0JBQWdCLENBQWtCO1FBQ2xDLFdBQU0sR0FBTixNQUFNLENBQWtCO0lBQy9CLENBQUM7SUFFRyxLQUFLO1FBQ1YsTUFBTSxZQUFZLEdBQUcsSUFBSSxZQUFZLEVBQUUsQ0FBQztRQUN4QyxZQUFZLENBQUMsQ0FBQyxHQUFHLElBQUksQ0FBQyxDQUFDLENBQUM7UUFDeEIsSUFBSSxJQUFJLENBQUMsZ0JBQWdCLElBQUksSUFBSSxDQUFDLGdCQUFnQixDQUFDLElBQUksRUFBRTtZQUN2RCxJQUFJLENBQUMsZ0JBQWdCLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFDLEdBQVksRUFBRSxLQUFhLEVBQUUsRUFBRTtnQkFDakUsTUFBTSxFQUFFLEdBQVcsS0FBSyxDQUFDO2dCQUN6QixJQUFJLFdBQVcsR0FBRyxDQUFDLENBQUMsQ0FBQztnQkFDckIsSUFBSSxLQUFLLENBQUM7Z0JBQ1YsTUFBTSxL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QUssQ0FBQztZQUMvQixDQUFDLENBQUMsU0FBUyxDQUFDO0lBQ2hCLENBQUM7SUFFTyxRQUFRLENBQUMsS0FBYTtRQUM1QixNQUFNLGFBQWEsR0FBRyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsS0FBSyxDQUFDLENBQUM7UUFDbkQsT0FBTyxLQUFLLENBQUMsY0FBYyxDQUN6QixhQUFhLEVBQ2IsSUFBSSxDQUFDLE1BQU0sRUFBRSxtQkFBbUIsQ0FDakMsQ0FBQztJQUNKLENBQUM7SUFFTyxnQkFBZ0IsQ0FBQyxLQUFhO1FBQ3BDLE1BQU0sTUFBTSxHQUFHLElBQUksQ0FBQyxzQkFBc0IsQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUNsRCxPQUFPLE1BQU0sRUFBRSxNQUFNLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxRQUFRLEVBQUUsT0FBTyxFQUFFLE9BQU8sRUFBRSxhQUFhLENBQUM7SUFDdkUsQ0FBQztJQUVPLFVBQVUsQ0FBQyxLQUFhLEVBQUUsS0FBYTtRQUM3QyxPQUFPLElBQUksQ0FBQyxLQUFLLENBQUMsUUFBUSxDQUFDLEtBQUssRUFBRSxFQUFFLENBQUMsR0FBRyxLQUFLLENBQUMsQ0FBQztJQUNqRCxDQUFDO0NBQ0YiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBNaW1lVmlld2VyQ29uZmlnIH0gZnJvbSAnLi4vLi4vbWltZS12aWV3ZXItY29uZmlnJztcbmltcG9ydCB7IFV0aWxzIH0gZnJvbSAnLi4vLi4vdXRpbHMnO1xuaW1wb3J0IHsgSGl0IH0gZnJvbSAnLi8uLi8uLi9tb2RlbHMvaGl0JztcbmltcG9ydCB7XG4gIEhpdCBhcyBJaWlmSGl0LFxuICBJaWlmU2VhcmNoUmVzdWx0LFxuICBSZXNvdXJjZSBhcyBJaWlmUmVzb3VyY2UsXG59IGZyb20gJy4vLi4vLi4vbW9kZWxzL2lpaWYtc2VhcmNoLXJlc3VsdCc7XG5pbXBvcnQgeyBDYW52YXMsIE1hbmlmZXN0LCBTZXF1ZW5jZSB9IGZyb20gJy4vLi4vLi4vbW9kZWxzL21hbmlmZXN0JztcbmltcG9ydCB7IFJlY3QgfSBmcm9tICcuLy4uLy4uL21vZGVscy9yZWN0JztcbmltcG9ydCB7IFNlYXJjaFJlc3VsdCB9IGZyb20gJy4vLi4vLi4vbW9kZWxzL3NlYXJjaC1yZXN1bHQnO1xuXG5leHBvcnQgY2xhc3MgU2VhcmNoUmVzdWx0QnVpbGRlciB7XG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgcTogc3RyaW5nLFxuICAgIHByaXZhdGUgbWFuaWZlc3Q6IE1hbmlmZXN0LFxuICAgIHByaXZhdGUgaWlpZlNlYXJjaFJlc3VsdDogSWlpZlNlYXJjaFJlc3VsdCxcbiAgICBwcml2YXRlIGNvbmZpZzogTWltZVZpZXdlckNvbmZpZ1xuICApIHt9XG5cbiAgcHVibGljIGJ1aWxkKCk6IFNlYXJjaFJlc3VsdCB7XG4gICAgY29uc3Qgc2VhcmNoUmVzdWx0ID0gbmV3IFNlYXJjaFJlc3VsdCgpO1xuICAgIHNlYXJjaFJlc3VsdC5xID0gdGhpcy5xO1xuICAgIGlmICh0aGlzLmlpaWZTZWFyY2hSZXN1bHQgJiYgdGhpcy5paWlmU2VhcmNoUmVzdWx0LmhpdHMpIHtcbiAgICAgIHRoaXMuaWlpZlNlYXJjaFJlc3VsdC5oaXRzLmZvckVhY2goKGhpdDogSWlpZkhpdCwgaW5kZXg6IG51bWJlcikgPT4ge1xuICAgICAgICBjb25zdCBpZDogbnVtYmVyID0gaW5kZXg7XG4gICAgICAgIGxldCBjYW52YXNJbmRleCA9IC0xO1xuICAgICAgICBsZXQgbGFiZWw7XG4gICAgICAgIGNvbnN0IHJlY3RzOiBSZWN0W10gPSBbXTtcbiAgICAgICAgaWYgKHRoaXMubWFuaWZlc3Quc2VxdWVuY2VzICYmIHRoaXMubWFuaWZlc3Quc2VxdWVuY2VzWzBdLmNhbnZhc2VzKSB7XG4gICAgICAgICAgY29uc3QgcmVzb3VyY2VzID0gdGhpcy5maW5kUmVzb3VyY2VzKGhpdCk7XG4gICAgICAgICAgZm9yIChjb25zdCByZXNvdXJjZSBvZiByZXNvdXJjZXMpIHtcbiAgICAgICAgICAgIGNhbnZhc0luZGV4ID0gdGhpcy5maW5kU2VxdWVuY2VJbmRleChyZXNvdXJjZSk7XG4gICAgICAgICAgICBsYWJlbCA9IHRoaXMuZmluZExhYmVsKGNhbnZhc0luZGV4KTtcbiAgICAgICAgICAgIGNvbnN0IG9uID0gcmVzb3VyY2Uub247XG4gICAgICAgICAgICBpZiAob24pIHtcbiAgICAgICAgICAgICAgY29uc3Qgc2NhbGUgPSB0aGlzLmdldFNjYWxlKGNhbnZhc0luZGV4KTtcbiAgICAgICAgICAgICAgY29uc3QgY29vcmRzID0gb24uc3Vic3RyaW5nKG9uLmluZGV4T2YoJz0nKSArIDEpLnNwbGl0KCcsJyk7XG4gICAgICAgICAgICAgIGNvbnN0IHJlY3QgPSBuZXcgUmVjdCh7XG4gICAgICAgICAgICAgICAgeDogdGhpcy5zY2FsZVZhbHVlKGNvb3Jkc1swXSwgc2NhbGUpLFxuICAgICAgICAgICAgICAgIHk6IHRoaXMuc2NhbGVWYWx1ZShjb29yZHNbMV0sIHNjYWxlKSxcbiAgICAgICAgICAgICAgICB3aWR0aDogdGhpcy5zY2FsZVZhbHVlKGNvb3Jkc1syXSwgc2NhbGUpLFxuICAgICAgICAgICAgICAgIGhlaWdodDogdGhpcy5zY2FsZVZhbHVlKGNvb3Jkc1szXSwgc2NhbGUpLFxuICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgcmVjdHMucHVzaChyZWN0KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICBzZWFyY2hSZXN1bHQuYWRkKFxuICAgICAgICAgIG5ldyBIaXQoe1xuICAgICAgICAgICAgaWQ6IGlkLFxuICAgICAgICAgICAgaW5kZXg6IGNhbnZhc0luZGV4LFxuICAgICAgICAgICAgbGFiZWw6IGxhYmVsLFxuICAgICAgICAgICAgbWF0Y2g6IGhpdC5tYXRjaCxcbiAgICAgICAgICAgIGJlZm9yZTogaGl0LmJlZm9yZSxcbiAgICAgICAgICAgIGFmdGVyOiBoaXQuYWZ0ZXIsXG4gICAgICAgICAgICByZWN0czogcmVjdHMsXG4gICAgICAgICAgfSlcbiAgICAgICAgKTtcbiAgICAgIH0pO1xuICAgIH1cbiAgICByZXR1cm4gc2VhcmNoUmVzdWx0O1xuICB9XG5cbiAgcHJpdmF0ZSBmaW5kUmVzb3VyY2VzKGhpdDogSWlpZkhpdCk6IElpaWZSZXNvdXJjZVtdIHtcbiAgICBjb25zdCByZXNvdXJjZXM6IElpaWZSZXNvdXJjZVtdID0gW107XG4gICAgaWYgKGhpdC5hbm5vdGF0aW9ucykge1xuICAgICAgZm9yIChjb25zdCBhbm5vdGF0aW9uIG9mIGhpdC5hbm5vdGF0aW9ucykge1xuICAgICAgICBpZiAodGhpcy5paWlmU2VhcmNoUmVzdWx0LnJlc291cmNlcykge1xuICAgICAgICAgIGNvbnN0IHJlcyA9IHRoaXMuaWlpZlNlYXJjaFJlc3VsdC5yZXNvdXJjZXMuZmluZChcbiAgICAgICAgICAgIChyOiBJaWlmUmVzb3VyY2UpID0+IHJbJ0BpZCddID09PSBhbm5vdGF0aW9uXG4gICAgICAgICAgKTtcbiAgICAgICAgICBpZiAocmVzKSB7XG4gICAgICAgICAgICByZXNvdXJjZXMucHVzaChyZXMpO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gcmVzb3VyY2VzO1xuICB9XG5cbiAgcHJpdmF0ZSBmaW5kU2VxdWVuY2VJbmRleChyZXNvdXJjZTogSWlpZlJlc291cmNlKTogbnVtYmVyIHtcbiAgICBpZiAoIXRoaXMubWFuaWZlc3Quc2VxdWVuY2VzKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ05vIHNlcXVlbmNlcyBmb3VuZCEnKTtcbiAgICB9XG4gICAgY29uc3QgZmlyc3RTZXF1ZW5jZSA9IHRoaXMuZ2V0Rmlyc3RTZXF1ZW5jZSgpO1xuICAgIGNvbnN0IG9uID0gcmVzb3VyY2Uub247XG4gICAgaWYgKG9uICYmIGZpcnN0U2VxdWVuY2UgJiYgZmlyc3RTZXF1ZW5jZS5jYW52YXNlcykge1xuICAgICAgY29uc3QgaWQgPSBvbi5zdWJzdHJpbmcoMCwgb24uaW5kZXhPZignIycpKTtcbiAgICAgIHJldHVybiBmaXJzdFNlcXVlbmNlLmNhbnZhc2VzLmZpbmRJbmRleCgoYykgPT4gYy5pZCA9PT0gaWQpO1xuICAgIH1cbiAgICByZXR1cm4gLTE7XG4gIH1cblxuICBwcml2YXRlIGZpbmRMYWJlbChpbmRleDogbnVtYmVyKTogc3RyaW5nIHwgdW5kZWZpbmVkIHtcbiAgICBpZiAoaW5kZXggPT09IC0xKSB7XG4gICAgICByZXR1cm4gdW5kZWZpbmVkO1xuICAgIH0gZWxzZSB7XG4gICAgICBjb25zdCBjYW52YXMgPSB0aGlzLmdldEZpcnN0U2VxdWVuY2VDYW52YXMoaW5kZXgpO1xuICAgICAgcmV0dXJuIGNhbnZhcyA/IGNhbnZhcy5sYWJlbCA6IHVuZGVmaW5lZDtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGdldEZpcnN0U2VxdWVuY2UoKTogU2VxdWVuY2UgfCB1bmRlZmluZWQge1xuICAgIGNvbnN0IHNlcXVlbmNlcyA9IHRoaXMubWFuaWZlc3Quc2VxdWVuY2VzO1xuICAgIHJldHVybiBzZXF1ZW5jZXMgPyBzZXF1ZW5jZXNbMF0gOiB1bmRlZmluZWQ7XG4gIH1cblxuICBwcml2YXRlIGdldEZpcnN0U2VxdWVuY2VDYW52YXMoaW5kZXg6IG51bWJlcik6IENhbnZhcyB8IHVuZGVmaW5lZCB7XG4gICAgY29uc3QgZmlyc3RTZXF1ZW5jZSA9IHRoaXMuZ2V0Rmlyc3RTZXF1ZW5jZSgpO1xuICAgIHJldHVybiBmaXJzdFNlcXVlbmNlICYmIGZpcnN0U2VxdWVuY2UuY2FudmFzZXMgIT09IHVuZGVmaW5lZFxuICAgICAgPyBmaXJzdFNlcXVlbmNlLmNhbnZhc2VzW2luZGV4XVxuICAgICAgOiB1bmRlZmluZWQ7XG4gIH1cblxuICBwcml2YXRlIGdldFNjYWxlKGluZGV4OiBudW1iZXIpOiBudW1iZXIge1xuICAgIGNvbnN0IHBoeXNpY2FsU2NhbGUgPSB0aGlzLmdldFBoeXNpY2FsU2NhbGUoaW5kZXgpO1xuICAgIHJldHVybiBVdGlscy5nZXRTY2FsZUZhY3RvcihcbiAgICAgIHBoeXNpY2FsU2NhbGUsXG4gICAgICB0aGlzLmNvbmZpZz8uaWdub3JlUGh5c2ljYWxTY2FsZVxuICAgICk7XG4gIH1cblxuICBwcml2YXRlIGdldFBoeXNpY2FsU2NhbGUoaW5kZXg6IG51bWJlcik6IG51bWJlciB8IHVuZGVmaW5lZCB7XG4gICAgY29uc3QgY2FudmFzID0gdGhpcy5nZXRGaXJzdFNlcXVlbmNlQ2FudmFzKGluZGV4KTtcbiAgICByZXR1cm4gY2FudmFzPy5pbWFnZXM/LlswXS5yZXNvdXJjZT8uc2VydmljZT8uc2VydmljZT8ucGh5c2ljYWxTY2FsZTtcbiAgfVxuXG4gIHByaXZhdGUgc2NhbGVWYWx1ZSh2YWx1ZTogc3RyaW5nLCBzY2FsZTogbnVtYmVyKTogbnVtYmVyIHtcbiAgICByZXR1cm4gTWF0aC50cnVuYyhwYXJzZUludCh2YWx1ZSwgMTApICogc2NhbGUpO1xuICB9XG59XG4iXX0=